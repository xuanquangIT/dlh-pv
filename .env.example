# ========================================================================================
# PV Lakehouse - Environment Configuration
# ========================================================================================
# This file contains all configurable environment variables for the PV Lakehouse platform.
#
# USAGE:
#   1. Copy this file to .env: cp .env.example .env
#   2. Update values for your environment
#   3. Never commit .env to version control!
#
# PROFILES:
#   - core:       MinIO, PostgreSQL, Spark, Trino, pgAdmin (data engineering)
#   - ml:         MLflow (machine learning tracking)
#   - orchestrate: Prefect (workflow orchestration)
#
# ========================================================================================

# ========================================================================================
# SECTION 1: CREDENTIALS & SECRETS
# ========================================================================================
# ⚠️ SECURITY: Change ALL default values in production!

# ----- Global Defaults -----
PV_USER=pvlakehouse
PV_PASSWORD=pvlakehouse

# ----- PostgreSQL -----
POSTGRES_USER=${PV_USER}
POSTGRES_PASSWORD=${PV_PASSWORD}
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
POSTGRES_DB=postgres
ICEBERG_CATALOG_DB=iceberg_catalog

# ----- MinIO Root (Admin) -----
MINIO_ROOT_USER=${PV_USER}
MINIO_ROOT_PASSWORD=${PV_PASSWORD}

# ----- MinIO Service Accounts (Least-Privilege) -----
# Each service has dedicated credentials with minimal required permissions
SPARK_SVC_ACCESS_KEY=spark_svc
SPARK_SVC_SECRET_KEY=pvlakehouse_spark
TRINO_SVC_ACCESS_KEY=trino_svc
TRINO_SVC_SECRET_KEY=pvlakehouse_trino
MLFLOW_SVC_ACCESS_KEY=mlflow_svc
MLFLOW_SVC_SECRET_KEY=pvlakehouse_mlflow

# ----- pgAdmin -----
PGADMIN_DEFAULT_EMAIL=admin@example.com
PGADMIN_DEFAULT_PASSWORD=${PV_PASSWORD}

# ========================================================================================
# SECTION 2: EXTERNAL API KEYS
# ========================================================================================
# Get your API key from: https://openelectricity.org.au

OPENELECTRICITY_API_KEY=your_api_key_here
OPENELECTRICITY_API_URL=https://api.openelectricity.org.au/v4

# Fallback API key (optional)
OPEN_NEM_SECONDARY=

# ========================================================================================
# SECTION 3: STORAGE CONFIGURATION
# ========================================================================================

MINIO_ENDPOINT=http://minio:9000
S3_REGION=us-east-1
S3_WAREHOUSE_BUCKET=lakehouse
S3_MLFLOW_BUCKET=mlflow

# ========================================================================================
# SECTION 4: SERVICE URLS
# ========================================================================================

MLFLOW_TRACKING_URI=http://mlflow:5000
PREFECT_API_URL=http://prefect:4200/api
PREFECT_WORK_POOL=default-pool
PREFECT_WORK_QUEUE=default

# ========================================================================================
# SECTION 5: APACHE SPARK CONFIGURATION
# ========================================================================================
# Tuning guide: Adjust based on your system resources
#
# RECOMMENDED SETTINGS BY SYSTEM SIZE:
# ┌─────────────────┬────────────┬────────────┬────────────┬─────────────┐
# │ System          │ 8GB RAM    │ 16GB RAM   │ 32GB RAM   │ 64GB+ RAM   │
# ├─────────────────┼────────────┼────────────┼────────────┼─────────────┤
# │ WORKER_CORES    │ 2          │ 4-8        │ 8-16       │ 16-32       │
# │ WORKER_MEMORY   │ 2G         │ 4-6G       │ 8-12G      │ 16-24G      │
# │ DRIVER_MEMORY   │ 1g         │ 2-3g       │ 4-6g       │ 8g          │
# │ EXECUTOR_MEMORY │ 2g         │ 3-4g       │ 6-8g       │ 12-16g      │
# │ EXECUTOR_CORES  │ 2          │ 4          │ 4-8        │ 8           │
# │ SHUFFLE_PARTS   │ 16         │ 32         │ 64-128     │ 200         │
# └─────────────────┴────────────┴────────────┴────────────┴─────────────┘

# ----- Worker Settings -----
SPARK_WORKER_CORES=8
SPARK_WORKER_MEMORY=6G
SPARK_WORKER_MEMORY_LIMIT=8g
SPARK_WORKER_CPU_LIMIT=10

# ----- Driver Settings (spark-submit client mode) -----
SPARK_DRIVER_MEMORY=3g
SPARK_DRIVER_CORES=2

# ----- Executor Settings -----
SPARK_EXECUTOR_MEMORY=4g
SPARK_EXECUTOR_CORES=4

# ----- Memory Management -----
# memory.fraction: Heap space for execution + storage (0.6 = 60%)
# storageFraction: Portion for caching (0.5 = 50% of memory.fraction)
SPARK_MEMORY_FRACTION=0.6
SPARK_MEMORY_STORAGE_FRACTION=0.5

# ----- Parallelism -----
# Rule: 2-4x worker cores for optimal performance
SPARK_SHUFFLE_PARTITIONS=32

# ----- Adaptive Query Execution (Spark 3.x) -----
SPARK_AQE_ENABLED=true
SPARK_AQE_COALESCE_PARTITIONS=true
SPARK_AQE_ADVISORY_PARTITION_SIZE=128MB

# ----- File Handling -----
SPARK_MAX_PARTITION_BYTES=256MB
SPARK_PARQUET_COMPRESSION=snappy
SPARK_ICEBERG_COMPRESSION=snappy

# ========================================================================================
# SECTION 6: DATABASE CONNECTIONS
# ========================================================================================

ICEBERG_DB=iceberg
ICEBERG_USER=${PV_USER}
ICEBERG_PASSWORD=${PV_PASSWORD}
MLFLOW_DB=mlflow
MLFLOW_USER=${PV_USER}
MLFLOW_PASSWORD=${PV_PASSWORD}

# ========================================================================================
# SECTION 7: SERVICE PORTS
# ========================================================================================
# Change these if you have port conflicts

MINIO_API_PORT=9000
MINIO_CONSOLE_PORT=9001
POSTGRES_PORT=5432
TRINO_PORT=8081
MLFLOW_PORT=5000
PREFECT_PORT=4200
SPARK_UI_PORT=4040
PGADMIN_PORT=5050

# ========================================================================================
# SECTION 8: DOCKER IMAGES
# ========================================================================================
# Pin specific versions for production stability

MINIO_IMAGE=minio/minio:latest
MC_IMAGE=minio/mc:latest
POSTGRES_IMAGE=postgres:15
SPARK_IMAGE=apache/spark:3.5.1
TRINO_IMAGE=trinodb/trino:latest
MLFLOW_BASE_IMAGE=python:3.11-slim
PREFECT_IMAGE=prefecthq/prefect:2-latest
PGADMIN_IMAGE=dpage/pgadmin4:latest

# ========================================================================================
# END OF CONFIGURATION
# ========================================================================================
