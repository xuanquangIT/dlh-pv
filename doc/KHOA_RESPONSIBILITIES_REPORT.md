# ğŸ“‹ BÃO CÃO CHI TIáº¾T CÃ”NG VIá»†C Cá»¦A CHUNG QUANG ÄÄ‚NG KHOA

**Dá»± Ãn:** PV Lakehouse - Há»‡ Thá»‘ng Data Lakehouse cho NÄƒng LÆ°á»£ng Máº·t Trá»i  
**Sinh ViÃªn:** Chung Quang ÄÄƒng Khoa  
**NgÃ y táº¡o:** 2025-12-22

---

## ğŸ“Œ Tá»”NG QUAN PHÃ‚N CÃ”NG

Theo báº£ng phÃ¢n cÃ´ng, Chung Quang ÄÄƒng Khoa chá»‹u trÃ¡ch nhiá»‡m cÃ¡c pháº§n sau:

| STT | Ná»™i dung cÃ´ng viá»‡c |
|-----|-------------------|
| 1 | CÃ i Ä‘áº·t vÃ  cáº¥u hÃ¬nh cÃ´ng nghá»‡/há»‡ thá»‘ng theo kiáº¿n trÃºc Data Lakehouse |
| 2 | NghiÃªn cá»©u nguá»“n dá»¯ liá»‡u Ä‘áº§u vÃ o cá»§a Ä‘á» tÃ i |
| 3 | Thá»±c hiá»‡n náº¡p dá»¯ liá»‡u vÃ o lá»›p Bronze |
| 4 | Xá»­ lÃ½, lÃ m sáº¡ch vÃ  chuáº©n hoÃ¡ dá»¯ liá»‡u á»Ÿ lá»›p Silver |

---

## ğŸ¯ KIáº¾N THá»¨C Ná»€N Táº¢NG

### ğŸ“– Giáº£i ThÃ­ch Thuáº­t Ngá»¯ Quan Trá»ng

TrÆ°á»›c khi Ä‘i vÃ o chi tiáº¿t, Ä‘Ã¢y lÃ  giáº£i thÃ­ch cÃ¡c thuáº­t ngá»¯ ká»¹ thuáº­t quan trá»ng:

---

#### ğŸ” ACID Support lÃ  gÃ¬?

**ACID** lÃ  4 tÃ­nh cháº¥t Ä‘áº£m báº£o dá»¯ liá»‡u Ä‘Æ°á»£c xá»­ lÃ½ **an toÃ n vÃ  nháº¥t quÃ¡n**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ACID PROPERTIES                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ğŸ…°ï¸ ATOMICITY (TÃ­nh nguyÃªn tá»­)                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  "All or Nothing" - Giao dá»‹ch hoÃ n thÃ nh TOÃ€N Bá»˜ hoáº·c KHÃ”NG gÃ¬ cáº£      â”‚
â”‚                                                                         â”‚
â”‚  VÃ­ dá»¥: Transfer tiá»n A â†’ B                                            â”‚
â”‚  âœ“ ThÃ nh cÃ´ng: A -100, B +100 (cáº£ hai xáº£y ra)                          â”‚
â”‚  âœ— Tháº¥t báº¡i: Rollback, khÃ´ng cÃ³ gÃ¬ thay Ä‘á»•i                            â”‚
â”‚                                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ğŸ…² CONSISTENCY (TÃ­nh nháº¥t quÃ¡n)                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                        â”‚
â”‚  Dá»¯ liá»‡u luÃ´n á»Ÿ tráº¡ng thÃ¡i há»£p lá»‡ theo business rules                  â”‚
â”‚                                                                         â”‚
â”‚  VÃ­ dá»¥: Sá»‘ dÆ° khÃ´ng Ä‘Æ°á»£c Ã¢m                                            â”‚
â”‚  âœ“ LuÃ´n Ä‘áº£m báº£o constraint sau má»—i transaction                         â”‚
â”‚                                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ğŸ…¸ ISOLATION (TÃ­nh Ä‘á»™c láº­p)                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚
â”‚  CÃ¡c giao dá»‹ch Ä‘á»“ng thá»i khÃ´ng áº£nh hÆ°á»Ÿng láº«n nhau                      â”‚
â”‚                                                                         â”‚
â”‚  VÃ­ dá»¥: User A vÃ  User B Ä‘á»c/ghi cÃ¹ng lÃºc                              â”‚
â”‚  âœ“ Má»—i transaction "nhÃ¬n tháº¥y" database nhÆ° thá»ƒ chá»‰ cÃ³ mÃ¬nh            â”‚
â”‚                                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ğŸ…³ DURABILITY (TÃ­nh bá»n vá»¯ng)                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  Dá»¯ liá»‡u Ä‘Ã£ commit KHÃ”NG BAO GIá»œ máº¥t, ká»ƒ cáº£ khi system crash           â”‚
â”‚                                                                         â”‚
â”‚  VÃ­ dá»¥: Sau khi INSERT thÃ nh cÃ´ng â†’ restart server                     â”‚
â”‚  âœ“ Dá»¯ liá»‡u váº«n cÃ²n Ä‘Ã³                                                  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Táº¡i sao ACID quan trá»ng cho Data Lakehouse?**

| Váº¥n Ä‘á» KHÃ”NG cÃ³ ACID | Háº­u quáº£ |
|---------------------|---------|
| Ghi file Ä‘ang Ä‘á»c | Data corruption, query sai káº¿t quáº£ |
| Crash giá»¯a chá»«ng | File khÃ´ng hoÃ n chá»‰nh, máº¥t dá»¯ liá»‡u |
| Concurrent writes | Data bá»‹ overwrite, mÃ¢u thuáº«n |

**Apache Iceberg cung cáº¥p ACID** cho data lake báº±ng cÃ¡ch:
- Sá»­ dá»¥ng **snapshot isolation** (má»—i write táº¡o version má»›i)
- **Optimistic concurrency control** (detect conflicts)
- **Atomic commit** (all-or-nothing file operations)

---

#### ğŸ“¦ Object Store lÃ  gÃ¬?

**Object Store** (Object Storage) lÃ  há»‡ thá»‘ng lÆ°u trá»¯ dá»¯ liá»‡u dÆ°á»›i dáº¡ng **objects** thay vÃ¬ files/blocks:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SO SÃNH KIá»‚U LÆ¯U TRá»®                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ğŸ“ FILE STORAGE (Truyá»n thá»‘ng)                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  /home/user/documents/report.pdf                                        â”‚
â”‚  - Cáº¥u trÃºc thÆ° má»¥c phÃ¢n cáº¥p                                           â”‚
â”‚  - Truy cáº­p qua filesystem                                             â”‚
â”‚  - KhÃ³ scale vÆ°á»£t single server                                        â”‚
â”‚                                                                         â”‚
â”‚  ğŸ“¦ OBJECT STORAGE (Hiá»‡n Ä‘áº¡i)                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  s3://bucket/prefix/object-key                                          â”‚
â”‚  - Flat namespace (khÃ´ng cÃ³ thÆ° má»¥c tháº­t)                              â”‚
â”‚  - Truy cáº­p qua HTTP API (GET/PUT/DELETE)                              â”‚
â”‚  - Scale vÃ´ háº¡n (distributed)                                          â”‚
â”‚  - CÃ³ metadata Ä‘i kÃ¨m má»—i object                                       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**VÃ­ dá»¥ Object trong MinIO/S3:**
```
Bucket: lakehouse
Key: warehouse/bronze/weather/date=2025-01-01/part-00001.parquet
Metadata: {
  "Content-Type": "application/octet-stream",
  "x-amz-meta-etl-version": "1.0"
}
Data: [binary parquet file content]
```

**Táº¡i sao Object Store tá»‘t cho Data Lakehouse?**

| Æ¯u Ä‘iá»ƒm | Giáº£i thÃ­ch |
|---------|------------|
| **Chi phÃ­ tháº¥p** | Ráº» hÆ¡n 80-90% so vá»›i database storage |
| **Scale vÃ´ háº¡n** | ThÃªm nodes = thÃªm capacity |
| **Durability cao** | Tá»± Ä‘á»™ng replicate qua nhiá»u servers |
| **API chuáº©n** | S3 API lÃ  standard, má»i tool Ä‘á»u há»— trá»£ |

---

#### ğŸ“‹ Open Formats lÃ  gÃ¬?

**Open Formats** lÃ  Ä‘á»‹nh dáº¡ng dá»¯ liá»‡u **khÃ´ng thuá»™c vá» vendor nÃ o**, cÃ³ spec cÃ´ng khai:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OPEN vs PROPRIETARY FORMATS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  âœ“ OPEN FORMATS                    âœ— PROPRIETARY FORMATS               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”‚
â”‚  â€¢ Apache Parquet                  â€¢ Oracle Database files              â”‚
â”‚  â€¢ Apache Iceberg                  â€¢ Snowflake internal                 â”‚
â”‚  â€¢ Apache ORC                      â€¢ SQL Server MDF/LDF                 â”‚
â”‚  â€¢ Apache Avro                     â€¢ Teradata storage                   â”‚
â”‚  â€¢ Delta Lake (open source)        â€¢ SAP HANA internal                  â”‚
â”‚                                                                         â”‚
â”‚  Æ¯u Ä‘iá»ƒm:                          NhÆ°á»£c Ä‘iá»ƒm:                          â”‚
â”‚  â€¢ Äá»c Ä‘Æ°á»£c báº±ng nhiá»u tools       â€¢ Lock-in vá»›i vendor                 â”‚
â”‚  â€¢ KhÃ´ng bá»‹ lock-in                â€¢ Chá»‰ vendor tool Ä‘á»c Ä‘Æ°á»£c           â”‚
â”‚  â€¢ Community phÃ¡t triá»ƒn            â€¢ Pháº£i tráº£ phÃ­ license               â”‚
â”‚  â€¢ Migrate dá»… dÃ ng                 â€¢ Migrate ráº¥t khÃ³                    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Apache Iceberg = Open Table Format:**
- Spec cÃ´ng khai: https://iceberg.apache.org/spec/
- Äá»c Ä‘Æ°á»£c báº±ng: Spark, Trino, Flink, Dremio, Snowflake, etc.
- KhÃ´ng cáº§n license

---

#### ğŸ“ Apache Parquet lÃ  gÃ¬? (File Format)

**Apache Parquet** lÃ  má»™t Ä‘á»‹nh dáº¡ng file **mÃ£ nguá»“n má»Ÿ** Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘áº·c biá»‡t cho **lÆ°u trá»¯ vÃ  phÃ¢n tÃ­ch dá»¯ liá»‡u lá»›n (Big Data)**. ÄÃ¢y lÃ  má»™t trong nhá»¯ng Ä‘á»‹nh dáº¡ng file phá»• biáº¿n nháº¥t trong há»‡ sinh thÃ¡i Data Engineering hiá»‡n Ä‘áº¡i.

---

##### ğŸ“œ Lá»‹ch Sá»­ vÃ  Nguá»“n Gá»‘c

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Lá»ŠCH Sá»¬ APACHE PARQUET                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  2012  â”‚  Twitter + Cloudera há»£p tÃ¡c phÃ¡t triá»ƒn                        â”‚
â”‚        â”‚  Má»¥c tiÃªu: Táº¡o columnar format cho Hadoop                     â”‚
â”‚        â”‚                                                                â”‚
â”‚  2013  â”‚  PhÃ¡t hÃ nh phiÃªn báº£n Ä‘áº§u tiÃªn                                 â”‚
â”‚        â”‚  Trá»Ÿ thÃ nh Apache Incubator project                           â”‚
â”‚        â”‚                                                                â”‚
â”‚  2015  â”‚  Trá»Ÿ thÃ nh Apache Top-Level Project                           â”‚
â”‚        â”‚  ÄÆ°á»£c Netflix, Uber, Airbnb Ã¡p dá»¥ng                           â”‚
â”‚        â”‚                                                                â”‚
â”‚  2020+ â”‚  Trá»Ÿ thÃ nh chuáº©n cÃ´ng nghiá»‡p cho Data Lake                    â”‚
â”‚        â”‚  Default format cho Iceberg, Delta Lake, Spark               â”‚
â”‚        â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**TÃªn gá»i "Parquet":** Láº¥y tá»« tiáº¿ng PhÃ¡p, nghÄ©a lÃ  **sÃ n gá»— ghÃ©p hÃ¬nh** (parquet flooring) - Ã¡m chá»‰ cÃ¡ch dá»¯ liá»‡u Ä‘Æ°á»£c sáº¯p xáº¿p theo cá»™t nhÆ° cÃ¡c thanh gá»— xáº¿p thÃ nh pattern.

---

##### ğŸ¯ Má»¥c ÄÃ­ch vÃ  Váº¥n Äá» Parquet Giáº£i Quyáº¿t

**TrÆ°á»›c Parquet, cÃ¡c váº¥n Ä‘á» vá»›i CSV/JSON trong Big Data:**

| Váº¥n Ä‘á» | MÃ´ táº£ | Háº­u quáº£ |
|--------|-------|---------|
| **Äá»c toÃ n bá»™ dÃ²ng** | DÃ¹ chá»‰ cáº§n 1 cá»™t, pháº£i Ä‘á»c táº¥t cáº£ | Tá»‘n I/O, cháº­m |
| **KhÃ´ng cÃ³ schema** | CSV khÃ´ng biáº¿t kiá»ƒu dá»¯ liá»‡u | Lá»—i parse, cáº§n guess types |
| **NÃ©n kÃ©m** | Dá»¯ liá»‡u khÃ¡c kiá»ƒu náº±m cáº¡nh nhau | Compression ratio tháº¥p |
| **KhÃ´ng chia tÃ¡ch Ä‘Æ°á»£c** | File lá»›n khÃ³ xá»­ lÃ½ song song | KhÃ´ng thá»ƒ parallel processing |

**Parquet Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ giáº£i quyáº¿t Táº¤T Cáº¢ cÃ¡c váº¥n Ä‘á» trÃªn:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PARQUET GIáº¢I QUYáº¾T GÃŒ?                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  âœ— Váº¤N Äá»€                          âœ“ GIáº¢I PHÃP PARQUET                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”‚
â”‚  Äá»c toÃ n bá»™ dÃ²ng              â†’   Columnar: Chá»‰ Ä‘á»c cá»™t cáº§n          â”‚
â”‚  KhÃ´ng cÃ³ schema               â†’   Schema nhÃºng trong file             â”‚
â”‚  NÃ©n kÃ©m                       â†’   Dá»¯ liá»‡u cÃ¹ng type â†’ nÃ©n tá»‘t hÆ¡n    â”‚
â”‚  KhÃ´ng parallel processing     â†’   Row Groups Ä‘á»™c láº­p â†’ parallel      â”‚
â”‚  KhÃ´ng cÃ³ statistics           â†’   Min/max per column â†’ skip blocks   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

##### ğŸ“ CÃ¡c KhÃ¡i Niá»‡m Cá»‘t LÃµi cá»§a Parquet

**1. Columnar Storage (LÆ°u trá»¯ theo cá»™t)**

Thay vÃ¬ lÆ°u dá»¯ liá»‡u theo dÃ²ng (row-by-row), Parquet lÆ°u theo cá»™t (column-by-column):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COLUMNAR vs ROW STORAGE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Dá»® LIá»†U Gá»C (Table):                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚   ID   â”‚   Name     â”‚ Temperature â”‚   Energy   â”‚                    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚  â”‚   1    â”‚  "NYNGAN"  â”‚    25.0     â”‚   100.5    â”‚                    â”‚
â”‚  â”‚   2    â”‚  "MOREE"   â”‚    28.0     â”‚   150.2    â”‚                    â”‚
â”‚  â”‚   3    â”‚  "ROMA"    â”‚    22.5     â”‚    80.0    â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                         â”‚
â”‚  ROW STORAGE (CSV, JSON):                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚
â”‚  [1, "NYNGAN", 25.0, 100.5] [2, "MOREE", 28.0, 150.2] [3, "ROMA", ...]  â”‚
â”‚                                                                         â”‚
â”‚  COLUMNAR STORAGE (Parquet):                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚
â”‚  ID:          [1, 2, 3]                      â† CÃ¹ng type â†’ nÃ©n tá»‘t     â”‚
â”‚  Name:        ["NYNGAN", "MOREE", "ROMA"]    â† CÃ¹ng type â†’ nÃ©n tá»‘t     â”‚
â”‚  Temperature: [25.0, 28.0, 22.5]             â† CÃ¹ng type â†’ nÃ©n tá»‘t     â”‚
â”‚  Energy:      [100.5, 150.2, 80.0]           â† CÃ¹ng type â†’ nÃ©n tá»‘t     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**2. Row Groups (NhÃ³m dÃ²ng)**

File Parquet Ä‘Æ°á»£c chia thÃ nh nhiá»u **Row Groups** (~128MB má»—i group):
- Má»—i Row Group chá»©a má»™t pháº§n cá»§a táº¥t cáº£ cÃ¡c cá»™t
- Cho phÃ©p **parallel processing** (Ä‘á»c nhiá»u Row Groups cÃ¹ng lÃºc)
- Cho phÃ©p **predicate pushdown** (skip Row Groups khÃ´ng cáº§n thiáº¿t)

**3. Column Chunks vÃ  Pages**

```
ROW GROUP
  â””â”€â”€ Column Chunk (1 column trong 1 row group)
        â””â”€â”€ Page (Ä‘Æ¡n vá»‹ nÃ©n nhá» nháº¥t, ~1MB)
              â””â”€â”€ Data Values (Ä‘Ã£ Ä‘Æ°á»£c encode + compress)
```

**4. Encoding (MÃ£ hÃ³a)**

Parquet sá»­ dá»¥ng nhiá»u ká»¹ thuáº­t encoding Ä‘á»ƒ giáº£m kÃ­ch thÆ°á»›c:

| Encoding | MÃ´ táº£ | VÃ­ dá»¥ |
|----------|-------|-------|
| **Dictionary** | Thay giÃ¡ trá»‹ láº·p báº±ng ID | "NYNGAN" â†’ 1, "MOREE" â†’ 2 |
| **Run-Length (RLE)** | MÃ£ hÃ³a chuá»—i giÃ¡ trá»‹ giá»‘ng nhau | [1,1,1,1,1] â†’ (1, 5) |
| **Delta** | LÆ°u chÃªnh lá»‡ch thay vÃ¬ giÃ¡ trá»‹ Ä‘áº§y Ä‘á»§ | [100,101,103] â†’ [100, +1, +2] |
| **Bit-Packing** | DÃ¹ng Ã­t bits hÆ¡n cho giÃ¡ trá»‹ nhá» | Sá»‘ 0-7 chá»‰ cáº§n 3 bits |

**5. Compression (NÃ©n)**

Sau khi encode, dá»¯ liá»‡u Ä‘Æ°á»£c nÃ©n báº±ng cÃ¡c thuáº­t toÃ¡n:

| Thuáº­t toÃ¡n | Tá»‘c Ä‘á»™ | Tá»· lá»‡ nÃ©n | Use case |
|------------|--------|-----------|----------|
| **Snappy** | âœ“ Ráº¥t nhanh | â–³ Trung bÃ¬nh | Default, balanced |
| **GZIP** | â–³ Trung bÃ¬nh | âœ“ Tá»‘t | Archive, storage optimization |
| **ZSTD** | âœ“ Nhanh | âœ“ Ráº¥t tá»‘t | Best of both worlds |
| **LZ4** | âœ“ Ráº¥t nhanh | â–³ Tháº¥p | Real-time processing |

---

##### ğŸ”‘ Táº¡i Sao Columnar Storage Quan Trá»ng Cho Analytics?

**VÃ­ dá»¥ cá»¥ thá»ƒ:**

```sql
-- TÃ­nh trung bÃ¬nh nhiá»‡t Ä‘á»™ cho facility NYNGAN
SELECT AVG(temperature_2m) 
FROM weather 
WHERE facility_code = 'NYNGAN';
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ROW vs COLUMNAR PERFORMANCE                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Báº¢NG: 1 triá»‡u dÃ²ng Ã— 20 cá»™t = 20 triá»‡u cells                          â”‚
â”‚                                                                         â”‚
â”‚  ğŸ“‹ ROW STORAGE (CSV/JSON):                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  â†’ Äá»c Táº¤T Cáº¢ 20 triá»‡u cells                                           â”‚
â”‚  â†’ Lá»c facility_code, tÃ­nh AVG temperature                             â”‚
â”‚  â†’ I/O: 100% data                                                       â”‚
â”‚  â†’ Thá»i gian: 15 giÃ¢y                                                   â”‚
â”‚                                                                         â”‚
â”‚  ğŸ“Š COLUMNAR STORAGE (Parquet):                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚  â†’ Chá»‰ Ä‘á»c 2 cá»™t: facility_code + temperature_2m                       â”‚
â”‚  â†’ I/O: 10% data (2/20 columns)                                        â”‚
â”‚  â†’ Thá»i gian: 1.5 giÃ¢y                                                  â”‚
â”‚                                                                         â”‚
â”‚  âš¡ SPEEDUP: 10x nhanh hÆ¡n!                                             â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

##### ğŸ“Š Parquet trong Ngá»¯ Cáº£nh Data Lakehouse

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PARQUET TRONG DATA LAKEHOUSE                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    APACHE ICEBERG (Table Format)                â”‚   â”‚
â”‚  â”‚  â€¢ Quáº£n lÃ½ metadata, schema, partitions                         â”‚   â”‚
â”‚  â”‚  â€¢ ACID transactions, time travel                               â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚  â”‚    â”‚Parquet  â”‚  â”‚Parquet  â”‚  â”‚Parquet  â”‚  â”‚Parquet  â”‚          â”‚   â”‚
â”‚  â”‚    â”‚File 1   â”‚  â”‚File 2   â”‚  â”‚File 3   â”‚  â”‚File 4   â”‚          â”‚   â”‚
â”‚  â”‚    â”‚(.parquetâ”‚  â”‚(.parquetâ”‚  â”‚(.parquetâ”‚  â”‚(.parquetâ”‚          â”‚   â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚
â”‚  â”‚           â†‘           â†‘           â†‘           â†‘                 â”‚   â”‚
â”‚  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚   â”‚
â”‚  â”‚                      Data Files (Parquet)                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â†‘                                                          â”‚
â”‚              â”‚ stored in                                                â”‚
â”‚              â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    MINIO (Object Storage)                       â”‚   â”‚
â”‚  â”‚  s3://lakehouse/warehouse/bronze/weather/*.parquet              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Quan há»‡ giá»¯a cÃ¡c thÃ nh pháº§n:**
- **MinIO:** LÆ°u trá»¯ cÃ¡c file Parquet
- **Parquet:** Äá»‹nh dáº¡ng file chá»©a dá»¯ liá»‡u thá»±c táº¿
- **Iceberg:** Quáº£n lÃ½ metadata, schema, transactions

---

**Apache Parquet** lÃ  Ä‘á»‹nh dáº¡ng file **columnar storage** tá»‘i Æ°u cho analytics vÃ  big data:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ROW vs COLUMNAR STORAGE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ğŸ“‹ ROW-BASED (CSV, JSON):                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  Row 1: [id=1, name="A", temp=25.0, energy=100]                        â”‚
â”‚  Row 2: [id=2, name="B", temp=28.0, energy=150]                        â”‚
â”‚  Row 3: [id=3, name="C", temp=22.0, energy=80]                         â”‚
â”‚                                                                         â”‚
â”‚  â†’ Äá»c cáº£ dÃ²ng, ká»ƒ cáº£ khi chá»‰ cáº§n 1 cá»™t                                â”‚
â”‚  â†’ Tá»‘t cho: INSERT/UPDATE tá»«ng dÃ²ng (OLTP)                             â”‚
â”‚                                                                         â”‚
â”‚  ğŸ“Š COLUMNAR (Parquet, ORC):                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚  Column 'id':     [1, 2, 3]           â† Stored together                â”‚
â”‚  Column 'name':   ["A", "B", "C"]     â† Stored together                â”‚
â”‚  Column 'temp':   [25.0, 28.0, 22.0]  â† Stored together                â”‚
â”‚  Column 'energy': [100, 150, 80]      â† Stored together                â”‚
â”‚                                                                         â”‚
â”‚  â†’ Chá»‰ Ä‘á»c cÃ¡c cá»™t cáº§n thiáº¿t                                           â”‚
â”‚  â†’ NÃ©n hiá»‡u quáº£ hÆ¡n (dá»¯ liá»‡u cÃ¹ng type)                                â”‚
â”‚  â†’ Tá»‘t cho: Analytics, aggregations (OLAP)                             â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**VÃ­ dá»¥ cá»¥ thá»ƒ:**
```sql
-- Query: TÃ­nh tá»•ng nÄƒng lÆ°á»£ng
SELECT SUM(energy_mwh) FROM energy WHERE facility_code = 'NYNGAN';

-- CSV/JSON: Pháº£i Ä‘á»c toÃ n bá»™ 20 columns Ã— 1 million rows = 20M cells
-- Parquet: Chá»‰ Ä‘á»c 2 columns (facility_code, energy_mwh) = 2M cells
-- â†’ Tiáº¿t kiá»‡m 90% I/O!
```

---

**â“ Táº¡i sao chá»n Parquet mÃ  khÃ´ng dÃ¹ng CSV, JSON, Avro, hay ORC?**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SO SÃNH FILE FORMATS                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     TiÃªu chÃ­     â”‚ Parquet  â”‚   CSV    â”‚   JSON   â”‚   Avro   â”‚        ORC           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Storage layout   â”‚ Columnar â”‚ Row      â”‚ Row      â”‚ Row      â”‚ Columnar             â”‚
â”‚ Compression      â”‚ âœ“ Tá»‘t    â”‚ â–³ CÃ³     â”‚ â–³ CÃ³     â”‚ âœ“ Tá»‘t    â”‚ âœ“ Ráº¥t tá»‘t            â”‚
â”‚ Schema support   â”‚ âœ“ CÃ³     â”‚ âœ— KhÃ´ng  â”‚ âœ— KhÃ´ng  â”‚ âœ“ CÃ³     â”‚ âœ“ CÃ³                 â”‚
â”‚ Nested types     â”‚ âœ“ CÃ³     â”‚ âœ— KhÃ´ng  â”‚ âœ“ CÃ³     â”‚ âœ“ CÃ³     â”‚ âœ“ CÃ³                 â”‚
â”‚ Analytics speed  â”‚ âœ“ Nhanh  â”‚ âœ— Cháº­m   â”‚ âœ— Cháº­m   â”‚ â–³ Trung  â”‚ âœ“ Nhanh              â”‚
â”‚ Spark support    â”‚ âœ“ Native â”‚ âœ“ CÃ³     â”‚ âœ“ CÃ³     â”‚ âœ“ CÃ³     â”‚ âœ“ Native             â”‚
â”‚ Trino support    â”‚ âœ“ Native â”‚ â–³ CÃ³     â”‚ â–³ CÃ³     â”‚ â–³ CÃ³     â”‚ âœ“ Native             â”‚
â”‚ Iceberg compat   â”‚ âœ“ ChÃ­nh  â”‚ âœ— KhÃ´ng  â”‚ âœ— KhÃ´ng  â”‚ âœ“ CÃ³     â”‚ âœ“ CÃ³                 â”‚
â”‚ Human readable   â”‚ âœ— KhÃ´ng  â”‚ âœ“ CÃ³     â”‚ âœ“ CÃ³     â”‚ âœ— KhÃ´ng  â”‚ âœ— KhÃ´ng              â”‚
â”‚ File size (1GB)  â”‚ ~150MB   â”‚ 1GB      â”‚ ~1.5GB   â”‚ ~200MB   â”‚ ~120MB               â”‚
â”‚ Industry std     â”‚ âœ“ Phá»• biáº¿nâ”‚ âœ“ Legacy â”‚ âœ“ APIs   â”‚ â–³ Kafka  â”‚ â–³ Hive ecosystem     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**So sÃ¡nh chi tiáº¿t tá»«ng format:**

| Format | Æ¯u Ä‘iá»ƒm | NhÆ°á»£c Ä‘iá»ƒm | Use Case |
|--------|---------|------------|----------|
| **CSV** | Äá»c Ä‘Æ°á»£c báº±ng máº¯t, má»i tool há»— trá»£ | KhÃ´ng cÃ³ schema, khÃ´ng nÃ©n, cháº­m | Data exchange, legacy systems |
| **JSON** | Flexible, nested data, APIs | Tá»‘n dung lÆ°á»£ng, cháº­m parse | Web APIs, config files |
| **Avro** | Schema evolution, compact, row-based | KhÃ´ng tá»‘t cho analytics | Kafka, data streaming |
| **ORC** | Ráº¥t tá»‘t cho Hive, nÃ©n tá»‘t nháº¥t | Ãt phá»• biáº¿n ngoÃ i Hive ecosystem | Hive data warehouses |
| **Parquet** | Analytics optimal, phá»• biáº¿n, Iceberg default | Binary (khÃ´ng Ä‘á»c Ä‘Æ°á»£c báº±ng máº¯t) | **Data Lakehouse, analytics** |

---

**VÃ­ dá»¥ so sÃ¡nh kÃ­ch thÆ°á»›c file thá»±c táº¿:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VÃ Dá»¤: 1 triá»‡u dÃ²ng dá»¯ liá»‡u weather (20 columns)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Format     â”‚ Size      â”‚ Compression â”‚ Read Time  â”‚ Query Time        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  CSV        â”‚ 180 MB    â”‚ None        â”‚ 15 sec     â”‚ 8 sec             â”‚
â”‚  CSV.gz     â”‚ 45 MB     â”‚ gzip        â”‚ 12 sec     â”‚ 10 sec            â”‚
â”‚  JSON       â”‚ 250 MB    â”‚ None        â”‚ 25 sec     â”‚ 12 sec            â”‚
â”‚  Avro       â”‚ 35 MB     â”‚ Deflate     â”‚ 5 sec      â”‚ 4 sec             â”‚
â”‚  ORC        â”‚ 22 MB     â”‚ ZLIB        â”‚ 3 sec      â”‚ 1.5 sec           â”‚
â”‚  Parquet    â”‚ 28 MB     â”‚ Snappy      â”‚ 3 sec      â”‚ 1.2 sec  âœ“ Best   â”‚
â”‚                                                                         â”‚
â”‚  * Query: SELECT facility_code, AVG(temperature_2m) GROUP BY 1         â”‚
â”‚  * Parquet nhanh nháº¥t vÃ¬ chá»‰ Ä‘á»c 2 columns (columnar storage)          â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Cáº¥u trÃºc file Parquet:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PARQUET FILE STRUCTURE                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  HEADER (Magic Number: "PAR1")                                â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  ROW GROUP 1 (Default: ~128MB data)                          â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚
â”‚  â”‚  â”‚ Column Chunk 1  â”‚ â”‚ Column Chunk 2  â”‚ â”‚ Column Chunk 3  â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ (facility_code) â”‚ â”‚ (timestamp)     â”‚ â”‚ (temperature)   â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ â”‚ Page 1      â”‚ â”‚ â”‚ â”‚ Page 1      â”‚ â”‚ â”‚ â”‚ Page 1      â”‚ â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ â”‚ (compressed)â”‚ â”‚ â”‚ â”‚ (compressed)â”‚ â”‚ â”‚ â”‚ (compressed)â”‚ â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ â”‚ Page 2      â”‚ â”‚ â”‚ â”‚ Page 2      â”‚ â”‚ â”‚ â”‚ Page 2      â”‚ â”‚ â”‚     â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  ROW GROUP 2 (tiáº¿p tá»¥c...)                                    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  FOOTER                                                       â”‚     â”‚
â”‚  â”‚  â€¢ Schema definition (column names, types)                   â”‚     â”‚
â”‚  â”‚  â€¢ Row group metadata (offsets, sizes)                       â”‚     â”‚
â”‚  â”‚  â€¢ Column statistics (min/max values for filtering)          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  FOOTER LENGTH + MAGIC NUMBER ("PAR1")                        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CÃ¡c tÃ­nh nÄƒng quan trá»ng cá»§a Parquet:**

| TÃ­nh nÄƒng | Giáº£i thÃ­ch | Lá»£i Ã­ch |
|-----------|------------|---------|
| **Column Statistics** | Min/max values per column chunk | Predicate pushdown (skip irrelevant data) |
| **Compression** | Snappy (fast), Gzip (better ratio), ZSTD | 70-90% size reduction |
| **Encoding** | Dictionary, Run-length, Delta | Further compression |
| **Schema in Footer** | Self-describing format | No external schema needed |
| **Splittable** | Row groups Ä‘á»™c láº­p | Parallel processing |

---

**âœ… Parquet Ä‘Æ°á»£c chá»n cho dá»± Ã¡n vÃ¬:**
- **Columnar storage:** Tá»‘i Æ°u cho analytics queries (SUM, AVG, GROUP BY)
- **Compression tá»‘t:** Giáº£m 80%+ kÃ­ch thÆ°á»›c so vá»›i CSV/JSON
- **Schema enforcement:** CÃ³ schema rÃµ rÃ ng, khÃ´ng cáº§n guess types
- **Iceberg default format:** TÃ­ch há»£p native vá»›i Apache Iceberg
- **Industry standard:** ÄÆ°á»£c Spark, Trino, AWS, Databricks, Snowflake há»— trá»£
- **Predicate pushdown:** Skip data blocks khÃ´ng cáº§n thiáº¿t â†’ nhanh hÆ¡n

---

#### ğŸ”„ Schema Evolution lÃ  gÃ¬?

**Schema Evolution** lÃ  kháº£ nÄƒng **thay Ä‘á»•i cáº¥u trÃºc báº£ng** (thÃªm/sá»­a/xÃ³a cá»™t) mÃ  **KHÃ”NG cáº§n rewrite toÃ n bá»™ dá»¯ liá»‡u**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SCHEMA EVOLUTION EXAMPLE                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ğŸ“… Version 1.0 (Jan 2025)                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  CREATE TABLE energy (                                                  â”‚
â”‚    facility_code STRING,                                                â”‚
â”‚    timestamp TIMESTAMP,                                                 â”‚
â”‚    energy_mwh DOUBLE                                                    â”‚
â”‚  )                                                                      â”‚
â”‚                                                                         â”‚
â”‚  ğŸ“… Version 2.0 (Mar 2025) - ThÃªm cá»™t má»›i                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚  ALTER TABLE energy ADD COLUMN quality_flag STRING                      â”‚
â”‚                                                                         â”‚
â”‚  âœ“ Vá»›i Schema Evolution (Iceberg):                                     â”‚
â”‚    - Chá»‰ update metadata                                                â”‚
â”‚    - Files cÅ© váº«n Ä‘á»c Ä‘Æ°á»£c (cá»™t má»›i = NULL)                            â”‚
â”‚    - Files má»›i cÃ³ cá»™t má»›i                                               â”‚
â”‚    - KHÃ”NG rewrite files cÅ©                                             â”‚
â”‚                                                                         â”‚
â”‚  âœ— KhÃ´ng cÃ³ Schema Evolution:                                          â”‚
â”‚    - Pháº£i Ä‘á»c Táº¤T Cáº¢ files cÅ©                                          â”‚
â”‚    - ThÃªm cá»™t NULL                                                      â”‚
â”‚    - Ghi láº¡i Táº¤T Cáº¢ files                                              â”‚
â”‚    - Tá»‘n thá»i gian vÃ  resources                                        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CÃ¡c loáº¡i Schema Evolution Ä‘Æ°á»£c há»— trá»£:**

| Thao tÃ¡c | Iceberg Support | MÃ´ táº£ |
|----------|-----------------|-------|
| **Add column** | âœ“ CÃ³ | ThÃªm cá»™t má»›i (old rows = NULL) |
| **Drop column** | âœ“ CÃ³ | XÃ³a cá»™t (soft delete trong metadata) |
| **Rename column** | âœ“ CÃ³ | Äá»•i tÃªn cá»™t |
| **Widen type** | âœ“ CÃ³ | int â†’ long, float â†’ double |
| **Reorder columns** | âœ“ CÃ³ | Thay Ä‘á»•i thá»© tá»± cá»™t |

**Táº¡i sao Schema Evolution quan trá»ng?**

Trong thá»±c táº¿, schema **LUÃ”N THAY Äá»”I**:
- API nguá»“n thÃªm fields má»›i
- Business requirements thay Ä‘á»•i
- Bug fixes cáº§n thÃªm columns

KhÃ´ng cÃ³ schema evolution â†’ pháº£i **recreate toÃ n bá»™ table** má»—i láº§n thay Ä‘á»•i â†’ ráº¥t tá»‘n kÃ©m!

---

#### ğŸ• Time Travel lÃ  gÃ¬?

**Time Travel** lÃ  kháº£ nÄƒng query dá»¯ liá»‡u á»Ÿ **báº¥t ká»³ thá»i Ä‘iá»ƒm nÃ o trong quÃ¡ khá»©**:

```sql
-- Query dá»¯ liá»‡u hiá»‡n táº¡i
SELECT * FROM energy WHERE facility_code = 'NYNGAN';

-- Query dá»¯ liá»‡u nhÆ° ngÃ y 01/01/2025
SELECT * FROM energy 
FOR TIMESTAMP AS OF '2025-01-01 00:00:00'
WHERE facility_code = 'NYNGAN';

-- Query dá»¯ liá»‡u á»Ÿ snapshot cá»¥ thá»ƒ
SELECT * FROM energy 
FOR VERSION AS OF 12345678901234
WHERE facility_code = 'NYNGAN';
```

**Use cases:**
- **Debugging:** So sÃ¡nh dá»¯ liá»‡u trÆ°á»›c/sau bug
- **Audit:** Xem dá»¯ liá»‡u táº¡i thá»i Ä‘iá»ƒm report
- **ML Training:** Reproduce model vá»›i data Ä‘Ãºng thá»i Ä‘iá»ƒm

---

### ğŸ  Data Lakehouse lÃ  gÃ¬?

**Data Lakehouse** lÃ  kiáº¿n trÃºc dá»¯ liá»‡u hiá»‡n Ä‘áº¡i káº¿t há»£p Æ°u Ä‘iá»ƒm cá»§a cáº£ **Data Lake** vÃ  **Data Warehouse**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SO SÃNH KIáº¾N TRÃšC Dá»® LIá»†U                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    DATA LAKE      â”‚   DATA WAREHOUSE  â”‚       DATA LAKEHOUSE          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Chi phÃ­ tháº¥p   â”‚ âœ“ ACID support    â”‚ âœ“ Chi phÃ­ tháº¥p (object store)â”‚
â”‚ âœ“ Má»i Ä‘á»‹nh dáº¡ng  â”‚ âœ“ SQL queries     â”‚ âœ“ ACID transactions          â”‚
â”‚ âœ“ Schema-on-read â”‚ âœ“ Data quality    â”‚ âœ“ SQL + ML workloads         â”‚
â”‚ âœ— KhÃ´ng cÃ³ ACID  â”‚ âœ— Chi phÃ­ cao     â”‚ âœ“ Schema evolution           â”‚
â”‚ âœ— "Data Swamp"   â”‚ âœ— Vendor lock-in  â”‚ âœ“ Open formats (Iceberg)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Táº¡i sao chá»n Data Lakehouse?**

| LÃ½ do | Giáº£i thÃ­ch |
|-------|------------|
| **Chi phÃ­ tháº¥p** | Sá»­ dá»¥ng object storage (MinIO/S3) thay vÃ¬ database Ä‘áº¯t tiá»n |
| **Linh hoáº¡t** | Há»— trá»£ cáº£ SQL analytics vÃ  Machine Learning trÃªn cÃ¹ng dá»¯ liá»‡u |
| **Open Source** | KhÃ´ng bá»‹ vendor lock-in, sá»­ dá»¥ng Apache Iceberg open format |
| **ACID Transactions** | Äáº£m báº£o tÃ­nh nháº¥t quÃ¡n dá»¯ liá»‡u nhÆ° database truyá»n thá»‘ng |
| **Time Travel** | CÃ³ thá»ƒ query dá»¯ liá»‡u á»Ÿ thá»i Ä‘iá»ƒm báº¥t ká»³ trong quÃ¡ khá»© |

---

### ğŸ›ï¸ Kiáº¿n TrÃºc Medallion (Bronze â†’ Silver â†’ Gold)

**Medallion Architecture** lÃ  mÃ´ hÃ¬nh tá»• chá»©c dá»¯ liá»‡u theo **3 lá»›p cháº¥t lÆ°á»£ng tÄƒng dáº§n**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MEDALLION ARCHITECTURE                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     ğŸ“¥ Data Sources                                          ğŸ“Š Consumers
          â”‚                                                        â–²
          â–¼                                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¥‰ BRONZE      â”‚â”€â”€â”€â–¶â”‚  ğŸ¥ˆ SILVER      â”‚â”€â”€â”€â–¶â”‚      ğŸ¥‡ GOLD            â”‚
â”‚  (Raw Data)     â”‚    â”‚  (Cleaned)      â”‚    â”‚  (Business Ready)       â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                         â”‚
â”‚ â€¢ Dá»¯ liá»‡u thÃ´   â”‚    â”‚ â€¢ Validated     â”‚    â”‚ â€¢ Aggregations          â”‚
â”‚ â€¢ Schema-on-readâ”‚    â”‚ â€¢ Deduplicated  â”‚    â”‚ â€¢ Business metrics      â”‚
â”‚ â€¢ Full fidelity â”‚    â”‚ â€¢ Quality flags â”‚    â”‚ â€¢ ML features           â”‚
â”‚ â€¢ Audit trail   â”‚    â”‚ â€¢ Standardized  â”‚    â”‚ â€¢ Dashboard-ready       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ğŸ“Š LUá»’NG Dá»® LIá»†U CHI TIáº¾T: Äáº¦U VÃ€O â†’ Xá»¬ LÃ â†’ Äáº¦U RA

#### ğŸ”„ Tá»•ng Quan Luá»“ng Dá»¯ Liá»‡u End-to-End

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              LUá»’NG Dá»® LIá»†U HOÃ€N CHá»ˆNH                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                         â”‚
â”‚  â”‚  ğŸŒ EXTERNAL APIs â”‚                                                                         â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                                                         â”‚
â”‚  â”‚ â€¢ Open-Meteo      â”‚      HTTP/JSON                                                          â”‚
â”‚  â”‚   Weather API     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚  â”‚                   â”‚                  â”‚                                                       â”‚
â”‚  â”‚ â€¢ Open-Meteo      â”‚      HTTP/JSON   â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Air Quality API â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚         ğŸ PYTHON ETL JOBS           â”‚      â”‚
â”‚  â”‚                   â”‚                  â”‚         â”‚  (load_facility_*.py)               â”‚      â”‚
â”‚  â”‚ â€¢ OpenElectricity â”‚      HTTP/JSON   â”‚         â”‚                                     â”‚      â”‚
â”‚  â”‚   API (NEM)       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  â€¢ Fetch tá»« API                     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚  â€¢ Transform to DataFrame           â”‚      â”‚
â”‚                                                   â”‚  â€¢ Rate limiting                    â”‚      â”‚
â”‚                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                  â”‚                              â”‚
â”‚                                                         PySpark DataFrame                      â”‚
â”‚                                                                  â”‚                              â”‚
â”‚                                                                  â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                              ğŸ¥‰ BRONZE LAYER                                         â”‚       â”‚
â”‚  â”‚                         (MinIO: s3://lakehouse/warehouse/bronze/)                    â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚                                                                                      â”‚       â”‚
â”‚  â”‚  Äáº¦U VÃ€O:                          Xá»¬ LÃ:                      Äáº¦U RA:              â”‚       â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”€â”€â”€â”€â”€â”€                      â”€â”€â”€â”€â”€â”€â”€â”€              â”‚       â”‚
â”‚  â”‚  â€¢ JSON tá»« API                     â€¢ MERGE INTO                â€¢ Parquet files      â”‚       â”‚
â”‚  â”‚  â€¢ Hourly weather data             â€¢ Deduplication             â€¢ Iceberg tables     â”‚       â”‚
â”‚  â”‚  â€¢ Hourly energy data               â€¢ Add ingest_timestamp      â€¢ Iceberg-managed    â”‚       â”‚
â”‚  â”‚  â€¢ Hourly air quality              â€¢ Schema preservation         tables             â”‚       â”‚
â”‚  â”‚                                                                                      â”‚       â”‚
â”‚  â”‚  TABLES:                                                                             â”‚       â”‚
â”‚  â”‚  â€¢ lh.bronze.raw_facility_weather     (~20 columns)                                 â”‚       â”‚
â”‚  â”‚  â€¢ lh.bronze.raw_facility_timeseries  (~8 columns)                                  â”‚       â”‚
â”‚  â”‚  â€¢ lh.bronze.raw_facility_air_quality (~12 columns)                                 â”‚       â”‚
â”‚  â”‚                                                                                      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                   â”‚                                             â”‚
â”‚                                          SparkSQL read                                         â”‚
â”‚                                                   â”‚                                             â”‚
â”‚                                                   â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                              ğŸ¥ˆ SILVER LAYER                                         â”‚       â”‚
â”‚  â”‚                         (MinIO: s3://lakehouse/warehouse/silver/)                    â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚                                                                                      â”‚       â”‚
â”‚  â”‚  Äáº¦U VÃ€O:                          Xá»¬ LÃ:                      Äáº¦U RA:              â”‚       â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”€â”€â”€â”€â”€â”€                      â”€â”€â”€â”€â”€â”€â”€â”€              â”‚       â”‚
â”‚  â”‚  â€¢ Bronze Iceberg tables           â€¢ Timezone conversion       â€¢ Clean Parquet     â”‚       â”‚
â”‚  â”‚  â€¢ Raw timestamped data            â€¢ Hourly aggregation        â€¢ Quality flags      â”‚       â”‚
â”‚  â”‚  â€¢ Hourly Bronze data              â€¢ Validation rules          â€¢ Iceberg tables    â”‚       â”‚
â”‚  â”‚  â€¢ UTC timestamps (energy)         â€¢ Quality flagging          â€¢ Partitioned by    â”‚       â”‚
â”‚  â”‚  â€¢ Local timestamps (weather)      â€¢ AQI calculation             date_hour         â”‚       â”‚
â”‚  â”‚                                                                                      â”‚       â”‚
â”‚  â”‚  TABLES:                                                                             â”‚       â”‚
â”‚  â”‚  â€¢ lh.silver.clean_hourly_energy      (~12 columns + quality)                       â”‚       â”‚
â”‚  â”‚  â€¢ lh.silver.clean_hourly_weather     (~20 columns + quality)                       â”‚       â”‚
â”‚  â”‚  â€¢ lh.silver.clean_hourly_air_quality (~15 columns + AQI)                           â”‚       â”‚
â”‚  â”‚                                                                                      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                   â”‚                                             â”‚
â”‚                                          SparkSQL read                                         â”‚
â”‚                                                   â”‚                                             â”‚
â”‚                                                   â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                              ğŸ¥‡ GOLD LAYER                                           â”‚       â”‚
â”‚  â”‚                         (MinIO: s3://lakehouse/warehouse/gold/)                      â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚                                                                                      â”‚       â”‚
â”‚  â”‚  Äáº¦U VÃ€O:                          Xá»¬ LÃ:                      Äáº¦U RA:              â”‚       â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”€â”€â”€â”€â”€â”€                      â”€â”€â”€â”€â”€â”€â”€â”€              â”‚       â”‚
â”‚  â”‚  â€¢ Silver clean tables             â€¢ JOIN energy + weather     â€¢ Fact tables       â”‚       â”‚
â”‚  â”‚  â€¢ Hourly clean data               â€¢ Feature engineering       â€¢ Dimension tables  â”‚       â”‚
â”‚  â”‚  â€¢ Quality-flagged records         â€¢ Daily/weekly aggregation  â€¢ ML features       â”‚       â”‚
â”‚  â”‚                                    â€¢ Business metrics          â€¢ Dashboard views   â”‚       â”‚
â”‚  â”‚                                                                                      â”‚       â”‚
â”‚  â”‚  TABLES:                                                                             â”‚       â”‚
â”‚  â”‚  â€¢ lh.gold.fact_solar_environmental   (energy + weather + air quality joined)       â”‚       â”‚
â”‚  â”‚  â€¢ lh.gold.dim_facility               (facility master data)                        â”‚       â”‚
â”‚  â”‚  â€¢ lh.gold.agg_daily_energy           (daily aggregations)                          â”‚       â”‚
â”‚  â”‚                                                                                      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                   â”‚                                             â”‚
â”‚                                          Trino SQL / Power BI                                  â”‚
â”‚                                                   â”‚                                             â”‚
â”‚                                                   â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                              ğŸ“Š CONSUMERS                                            â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚  â€¢ Power BI Dashboards          â†’ Business Intelligence                             â”‚       â”‚
â”‚  â”‚  â€¢ MLflow + Spark ML            â†’ Model Training                                    â”‚       â”‚
â”‚  â”‚  â€¢ Ad-hoc SQL (Trino)           â†’ Data Analysis                                     â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ğŸ“¥ğŸ“¤ Äáº¦U VÃ€O / Äáº¦U RA Cá»¤ THá»‚ Tá»ªNG LAYER

#### ğŸ¥‰ BRONZE LAYER - Chi Tiáº¿t

| Aspect | Weather | Energy | Air Quality |
|--------|---------|--------|-------------|
| **Äáº¦U VÃ€O** ||||
| Source API | Open-Meteo Archive/Forecast | OpenElectricity NEM | Open-Meteo Air Quality |
| Format | JSON | JSON | JSON |
| Frequency | Hourly | Hourly | Hourly |
| Timezone | **Local time** | **UTC** | **Local time** |
| Request rate | 30/min | 60/min | 30/min |
| **Xá»¬ LÃ** ||||
| ETL Job | `load_facility_weather.py` | `load_facility_timeseries.py` | `load_facility_air_quality.py` |
| Transformation | Flatten JSON â†’ DataFrame | Flatten JSON â†’ DataFrame | Flatten JSON â†’ DataFrame |
| Deduplication | ROW_NUMBER() + MERGE | ROW_NUMBER() + MERGE | ROW_NUMBER() + MERGE |
| **Äáº¦U RA** ||||
| Table | `lh.bronze.raw_facility_weather` | `lh.bronze.raw_facility_timeseries` | `lh.bronze.raw_facility_air_quality` |
| Format | Parquet (Iceberg) | Parquet (Iceberg) | Parquet (Iceberg) |
| Location | `s3://lakehouse/warehouse/bronze/` | `s3://lakehouse/warehouse/bronze/` | `s3://lakehouse/warehouse/bronze/` |
| Tracking column | `ingest_timestamp` | `ingest_timestamp` | `ingest_timestamp` |

**VÃ­ dá»¥ dá»¯ liá»‡u Bronze Weather:**
```
Äáº¦U VÃ€O (JSON tá»« API):
{
  "hourly": {
    "time": ["2025-01-01T00:00", "2025-01-01T01:00", ...],
    "shortwave_radiation": [0, 0, 50, 200, ...],
    "temperature_2m": [18.5, 17.2, 16.8, ...]
  }
}

        â”‚
        â–¼  flatten + add metadata

Äáº¦U RA (Parquet trong Iceberg):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚facility_code â”‚  weather_timestamp â”‚ shortwave_radiation â”‚ temperature_2m â”‚ ingest_timestampâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NYNGAN       â”‚ 2025-01-01 00:00   â”‚ 0.0                 â”‚ 18.5           â”‚ 2025-01-02 08:00â”‚
â”‚ NYNGAN       â”‚ 2025-01-01 01:00   â”‚ 0.0                 â”‚ 17.2           â”‚ 2025-01-02 08:00â”‚
â”‚ NYNGAN       â”‚ 2025-01-01 02:00   â”‚ 50.0                â”‚ 16.8           â”‚ 2025-01-02 08:00â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### ğŸ¥ˆ SILVER LAYER - Chi Tiáº¿t

| Aspect | Energy | Weather | Air Quality |
|--------|--------|---------|-------------|
| **Äáº¦U VÃ€O** ||||
| Source | `lh.bronze.raw_facility_timeseries` | `lh.bronze.raw_facility_weather` | `lh.bronze.raw_facility_air_quality` |
| Granularity | Hourly (raw) | Hourly | Hourly |
| Timezone | UTC | Local | Local |
| **Xá»¬ LÃ** ||||
| Timezone Convert | UTC â†’ Local (per facility) | KhÃ´ng cáº§n | KhÃ´ng cáº§n |
| Aggregation | KhÃ´ng (already hourly) | KhÃ´ng (already hourly) | KhÃ´ng |
| Validation | Bounds + anomaly detection | Bounds + physics checks | Bounds + AQI calculation |
| Quality Flags | GOOD / WARNING / BAD | GOOD / WARNING / BAD | GOOD / WARNING |
| **Äáº¦U RA** ||||
| Table | `lh.silver.clean_hourly_energy` | `lh.silver.clean_hourly_weather` | `lh.silver.clean_hourly_air_quality` |
| New Columns | `quality_flag`, `quality_issues` | `is_valid`, `quality_flag` | `aqi_value`, `aqi_category` |
| Partition | By `date_hour` | By `date_hour` | By `date_hour` |

**VÃ­ dá»¥ transformation Energy (Bronze â†’ Silver):**
```
Äáº¦U VÃ€O (Bronze - Hourly intervals, UTC):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚facility_code â”‚     interval_ts     â”‚ metric â”‚ value â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NYNGAN       â”‚ 2025-01-01 22:00 UTCâ”‚ energy â”‚ 102.5 â”‚  â† Hour [22:00-23:00) UTC
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼  (1) Convert UTC â†’ Sydney local
                    â–¼  (2) Apply validation rules
                    â–¼  (3) Add quality flags

Äáº¦U RA (Silver - hourly, local time):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚facility_code â”‚      date_hour      â”‚ energy_mwh â”‚quality_flagâ”‚ quality_issues â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NYNGAN       â”‚ 2025-01-02 10:00 SYDâ”‚ 102.5      â”‚ GOOD       â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                 Hour-end label: 10:00
                                 (nÄƒng lÆ°á»£ng phÃ¡t sinh trong [09:00-10:00))
```

---

#### ğŸ¥‡ GOLD LAYER - Chi Tiáº¿t

| Aspect | Fact Table | Dimension Table |
|--------|------------|-----------------|
| **Äáº¦U VÃ€O** |||
| Sources | `lh.silver.clean_hourly_energy` + `lh.silver.clean_hourly_weather` + `lh.silver.clean_hourly_air_quality` | Facility metadata |
| Join Key | `facility_code` + `date_hour` | `facility_code` |
| **Xá»¬ LÃ** |||
| JOIN | INNER JOIN on facility + hour | N/A |
| Filter | Only GOOD quality records | N/A |
| Features | Lag features, rolling averages | Capacity, location |
| **Äáº¦U RA** |||
| Table | `lh.gold.fact_solar_environmental` | `lh.gold.dim_facility` |
| Use Case | ML training, dashboards | Lookup table |

**VÃ­ dá»¥ Gold fact table:**
```
Äáº¦U VÃ€O (3 Silver tables):

Silver Energy:                    Silver Weather:                   Silver Air Quality:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚facilityâ”‚date_hour â”‚ MWh â”‚       â”‚facilityâ”‚date_hour â”‚ rad  â”‚       â”‚facilityâ”‚date_hour â”‚ pm25 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
â”‚ NYNGAN â”‚ 10:00    â”‚102.5â”‚       â”‚ NYNGAN â”‚ 10:00    â”‚ 850  â”‚       â”‚ NYNGAN â”‚ 10:00    â”‚ 12.5 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                 â”‚                                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼ JOIN on (facility_code, date_hour)

Äáº¦U RA (Gold Fact Table):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚facility_code â”‚   date_hour  â”‚ energy_mwh â”‚shortwave_radiation  â”‚ pm25 â”‚ aqi_category â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NYNGAN       â”‚ 10:00        â”‚ 102.5      â”‚ 850                 â”‚ 12.5 â”‚ Good         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ğŸ” CÃCH DI CHUYá»‚N Dá»® LIá»†U GIá»®A CÃC LAYER

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DATA MOVEMENT MECHANISMS                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  ğŸŒ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ ğŸ¥‰ BRONZE                                          â”‚
â”‚           â”‚                            â”‚                                            â”‚
â”‚  Method:  â”‚    PySpark + Requests      â”‚  Trigger: Scheduled (Prefect) hoáº·c manual â”‚
â”‚           â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  Frequency: Hourly incremental             â”‚
â”‚           â”‚    1. HTTP GET to API      â”‚  Storage: MinIO s3://lakehouse/bronze/     â”‚
â”‚           â”‚    2. Parse JSON           â”‚  Format: Parquet (Iceberg managed)         â”‚
â”‚           â”‚    3. Create DataFrame     â”‚  Retention: Indefinite (raw data backup)   â”‚
â”‚           â”‚    4. spark.write.iceberg  â”‚                                            â”‚
â”‚           â”‚    5. MERGE INTO table     â”‚                                            â”‚
â”‚                                                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  ğŸ¥‰ BRONZE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ ğŸ¥ˆ SILVER                                         â”‚
â”‚           â”‚                            â”‚                                            â”‚
â”‚  Method:  â”‚    PySpark SQL             â”‚  Trigger: After Bronze load completes      â”‚
â”‚           â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚  Frequency: Hourly incremental             â”‚
â”‚           â”‚    1. spark.sql("SELECT    â”‚  Storage: MinIO s3://lakehouse/silver/     â”‚
â”‚           â”‚       FROM bronze.table")  â”‚  Format: Parquet (Iceberg managed)         â”‚
â”‚           â”‚    2. Transform DataFrame  â”‚  Retention: Indefinite (analytics ready)   â”‚
â”‚           â”‚    3. Add quality columns  â”‚                                            â”‚
â”‚           â”‚    4. MERGE INTO silver    â”‚                                            â”‚
â”‚                                                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  ğŸ¥ˆ SILVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ ğŸ¥‡ GOLD                                           â”‚
â”‚           â”‚                            â”‚                                            â”‚
â”‚  Method:  â”‚    PySpark SQL + JOIN      â”‚  Trigger: After Silver load completes      â”‚
â”‚           â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚  Frequency: Hourly or daily batch          â”‚
â”‚           â”‚    1. SELECT FROM energy   â”‚  Storage: MinIO s3://lakehouse/gold/       â”‚
â”‚           â”‚    2. JOIN weather ON key  â”‚  Format: Parquet (Iceberg managed)         â”‚
â”‚           â”‚    3. JOIN air_quality     â”‚  Consumers: Power BI, MLflow               â”‚
â”‚           â”‚    4. Feature engineering  â”‚                                            â”‚
â”‚           â”‚    5. INSERT INTO gold     â”‚                                            â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---


#### ğŸ¥‰ BRONZE Layer (Lá»›p Äá»“ng)

**Má»¥c Ä‘Ã­ch:** LÆ°u trá»¯ dá»¯ liá»‡u THÃ” tá»« nguá»“n, khÃ´ng thay Ä‘á»•i

| Äáº·c Ä‘iá»ƒm | MÃ´ Táº£ |
|----------|-------|
| **TÃ­nh cháº¥t** | Raw data, chÆ°a xá»­ lÃ½ |
| **Schema** | Schema-on-read (giá»¯ nguyÃªn tá»« nguá»“n) |
| **Cháº¥t lÆ°á»£ng** | CÃ³ thá»ƒ chá»©a lá»—i, duplicates, nulls |
| **Má»¥c Ä‘Ã­ch** | Audit trail, backup, reprocessing |
| **VÃ­ dá»¥** | `raw_facility_weather`, `raw_facility_timeseries` |

**Táº¡i sao cáº§n Bronze?**
- âœ… **Backup nguá»“n gá»‘c:** LuÃ´n cÃ³ thá»ƒ quay láº¡i dá»¯ liá»‡u gá»‘c
- âœ… **Reprocessing:** CÃ³ thá»ƒ cháº¡y láº¡i transformation khi logic thay Ä‘á»•i
- âœ… **Debugging:** So sÃ¡nh Bronze vs Silver Ä‘á»ƒ tÃ¬m lá»—i
- âœ… **Audit compliance:** LÆ°u trá»¯ Ä‘áº§y Ä‘á»§ cho compliance

#### ğŸ¥ˆ SILVER Layer (Lá»›p Báº¡c)

**Má»¥c Ä‘Ã­ch:** Dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c LÃ€M Sáº CH vÃ  CHUáº¨N HÃ“A

| Äáº·c Ä‘iá»ƒm | MÃ´ Táº£ |
|----------|-------|
| **TÃ­nh cháº¥t** | Cleaned, validated, deduplicated |
| **Schema** | Schema chuáº©n hÃ³a, cÃ³ quality flags |
| **Cháº¥t lÆ°á»£ng** | Passed validation rules |
| **Má»¥c Ä‘Ã­ch** | Analytics, ML training |
| **VÃ­ dá»¥** | `clean_hourly_energy`, `clean_hourly_weather` |

**Xá»­ lÃ½ á»Ÿ Silver:**
- âœ… **Deduplication:** Loáº¡i bá» báº£n ghi trÃ¹ng
- âœ… **Validation:** Kiá»ƒm tra bounds, business rules
- âœ… **Standardization:** Chuáº©n hÃ³a units, timezone
- âœ… **Quality Flags:** Gáº¯n cá» GOOD/WARNING/BAD

#### ğŸ¥‡ GOLD Layer (Lá»›p VÃ ng)

**Má»¥c Ä‘Ã­ch:** Dá»¯ liá»‡u Sáº´N SÃ€NG cho business vÃ  analytics

| Äáº·c Ä‘iá»ƒm | MÃ´ Táº£ |
|----------|-------|
| **TÃ­nh cháº¥t** | Aggregated, business-ready |
| **Schema** | Star/Snowflake schema |
| **Cháº¥t lÆ°á»£ng** | Production-ready |
| **Má»¥c Ä‘Ã­ch** | Dashboards, reporting, ML serving |
| **VÃ­ dá»¥** | `fact_solar_environmental`, `dim_facility` |

**Xá»­ lÃ½ á»Ÿ Gold:**
- âœ… **Aggregations:** Tá»•ng há»£p theo ngÃ y/tuáº§n/thÃ¡ng
- âœ… **Business Rules:** TÃ­nh toÃ¡n KPIs
- âœ… **Feature Engineering:** Táº¡o features cho ML
- âœ… **Dimension Tables:** Táº¡o cÃ¡c báº£ng dimension

---

### ğŸ”„ ELT Pattern lÃ  gÃ¬?

**ELT (Extract-Load-Transform)** lÃ  mÃ´ hÃ¬nh xá»­ lÃ½ dá»¯ liá»‡u hiá»‡n Ä‘áº¡i, khÃ¡c vá»›i ETL truyá»n thá»‘ng:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ETL vs ELT COMPARISON                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ğŸ“¦ ETL (Extract-Transform-Load) - TRUYá»€N THá»NG                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                       â”‚
â”‚  Source â†’ [Transform trÆ°á»›c khi load] â†’ Data Warehouse                  â”‚
â”‚           â†‘                                                             â”‚
â”‚           Transform xáº£y ra TRÆ¯á»šC khi dá»¯ liá»‡u vÃ o warehouse              â”‚
â”‚           Máº¥t mÃ¡t dá»¯ liá»‡u gá»‘c, khÃ³ debug                                â”‚
â”‚                                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ğŸ“¦ ELT (Extract-Load-Transform) - HIá»†N Äáº I                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”‚
â”‚  Source â†’ [Load raw vÃ o Bronze] â†’ [Transform trong Lakehouse]          â”‚
â”‚                    â†“                           â†“                        â”‚
â”‚               Giá»¯ nguyÃªn gá»‘c            Silver/Gold layers              â”‚
â”‚               CÃ³ thá»ƒ reprocess          Schema evolution                â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
Extract â†’ Load (Bronze) â†’ Transform (Spark) â†’ Load (Silver/Gold)
```

**Táº¡i sao chá»n ELT thay vÃ¬ ETL?**

| Lá»£i Ã­ch | MÃ´ Táº£ |
|---------|-------|
| **Raw Data Preserved** | Bronze layer giá»¯ nguyÃªn dá»¯ liá»‡u gá»‘c cho audit & reprocessing |
| **Reproducible** | CÃ³ thá»ƒ transform láº¡i tá»« Bronze mÃ  khÃ´ng cáº§n gá»i láº¡i API |
| **Debuggable** | So sÃ¡nh Bronze vs Silver Ä‘á»ƒ trace data issues |
| **Schema Evolution** | Bronze giá»¯ schema gá»‘c, Silver normalize |
| **Cost Effective** | Transform trong Lakehouse ráº» hÆ¡n trong ETL tools |

---

### ğŸ› ï¸ Táº¡i Sao Chá»n CÃ¡c CÃ´ng Nghá»‡ NÃ y? (Chi Tiáº¿t)

#### 1. MinIO - Object Storage

**â“ Táº¡i sao chá»n MinIO mÃ  khÃ´ng dÃ¹ng cÃ´ng nghá»‡ khÃ¡c?**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SO SÃNH OBJECT STORAGE                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   TiÃªu chÃ­   â”‚    MinIO     â”‚   AWS S3     â”‚    HDFS      â”‚ Local FS   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Chi phÃ­      â”‚ âœ“ Miá»…n phÃ­  â”‚ âœ— Tá»‘n tiá»n   â”‚ âœ“ Miá»…n phÃ­  â”‚ âœ“ Miá»…n phÃ­â”‚
â”‚ Local dev    â”‚ âœ“ Dá»… dÃ ng   â”‚ âœ— Cáº§n internetâ”‚ âœ— Phá»©c táº¡p â”‚ âœ“ Dá»…      â”‚
â”‚ S3 Compatibleâ”‚ âœ“ 100%      â”‚ âœ“ Native     â”‚ âœ— KhÃ´ng     â”‚ âœ— KhÃ´ng   â”‚
â”‚ Scale Ä‘Æ°á»£c   â”‚ âœ“ Tá»‘t       â”‚ âœ“ Ráº¥t tá»‘t    â”‚ âœ“ Ráº¥t tá»‘t  â”‚ âœ— KhÃ´ng   â”‚
â”‚ Single node  â”‚ âœ“ CÃ³        â”‚ N/A          â”‚ âœ— KhÃ´ng     â”‚ âœ“ CÃ³      â”‚
â”‚ API chuáº©n    â”‚ âœ“ S3        â”‚ âœ“ S3         â”‚ âœ— HDFS API â”‚ âœ— KhÃ´ng   â”‚
â”‚ Iceberg OK   â”‚ âœ“ Tá»‘t       â”‚ âœ“ Tá»‘t        â”‚ âœ“ OK       â”‚ âœ— Háº¡n cháº¿ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**LÃ½ do chi tiáº¿t:**

| CÃ¢u há»i | Tráº£ lá»i |
|---------|---------|
| **Táº¡i sao khÃ´ng dÃ¹ng AWS S3?** | Chi phÃ­ tÄƒng theo dá»¯ liá»‡u, cáº§n káº¿t ná»‘i internet, khÃ³ dev local. Dá»± Ã¡n há»c thuáº­t nÃªn cáº§n giáº£i phÃ¡p miá»…n phÃ­. |
| **Táº¡i sao khÃ´ng dÃ¹ng HDFS?** | Cáº§n tá»‘i thiá»ƒu 3 nodes Ä‘á»ƒ cháº¡y Ä‘Ãºng cÃ¡ch, quÃ¡ phá»©c táº¡p cho single-machine. Cáº§n Hadoop ecosystem. |
| **Táº¡i sao khÃ´ng dÃ¹ng Local filesystem?** | KhÃ´ng cÃ³ API chuáº©n (S3), khÃ³ migrate lÃªn cloud sau nÃ y, khÃ´ng há»— trá»£ versioning. |
| **Táº¡i sao khÃ´ng dÃ¹ng Google Cloud Storage?** | TÆ°Æ¡ng tá»± AWS S3 - tá»‘n phÃ­, cáº§n internet, vendor lock-in. |

**âœ… MinIO Ä‘Æ°á»£c chá»n vÃ¬:**
- Cháº¡y Ä‘Æ°á»£c trÃªn laptop Ä‘áº¿n datacenter (scalable)
- TÆ°Æ¡ng thÃ­ch 100% API S3 â†’ dá»… migrate lÃªn AWS/GCP sau nÃ y
- Há»— trá»£ versioning (cáº§n cho Iceberg time travel)
- Docker container sáºµn sÃ ng, dá»… deploy
- ÄÆ°á»£c sá»­ dá»¥ng rá»™ng rÃ£i trong production (VMware, Red Hat, etc.)

---

#### 2. Apache Iceberg - Table Format

**â“ Táº¡i sao chá»n Iceberg mÃ  khÃ´ng dÃ¹ng Delta Lake hay Hudi?**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SO SÃNH TABLE FORMATS                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     TiÃªu chÃ­     â”‚   Iceberg    â”‚  Delta Lake  â”‚      Apache Hudi       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Vendor neutral   â”‚ âœ“ Apache     â”‚ âœ— Databricks â”‚ âœ“ Apache               â”‚
â”‚ Trino support    â”‚ âœ“ Native     â”‚ â–³ Limited    â”‚ â–³ Limited              â”‚
â”‚ Spark support    â”‚ âœ“ Native     â”‚ âœ“ Native     â”‚ âœ“ Native               â”‚
â”‚ Schema evolution â”‚ âœ“ Tá»‘t        â”‚ âœ“ Tá»‘t        â”‚ â–³ Phá»©c táº¡p             â”‚
â”‚ Time travel      â”‚ âœ“ Snapshot   â”‚ âœ“ Version    â”‚ â–³ Commit-based         â”‚
â”‚ Hidden partition â”‚ âœ“ CÃ³         â”‚ âœ— KhÃ´ng      â”‚ âœ— KhÃ´ng                â”‚
â”‚ Community        â”‚ âœ“ Growing    â”‚ âœ“ Large      â”‚ â–³ Smaller              â”‚
â”‚ Complexity       â”‚ âœ“ Simple     â”‚ âœ“ Medium     â”‚ âœ— Complex              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âœ… Iceberg Ä‘Æ°á»£c chá»n vÃ¬:**
- **Vendor neutral:** KhÃ´ng bá»‹ lock vÃ o Databricks (Delta Lake cáº§n Databricks Ä‘á»ƒ full features)
- **Multi-engine support:** Trino + Spark Ä‘á»u há»— trá»£ native
- **Hidden partitioning:** Tá»± Ä‘á»™ng optimize mÃ  khÃ´ng cáº§n user chá»‰ Ä‘á»‹nh
- **ÄÆ°á»£c cÃ¡c cÃ´ng ty lá»›n sá»­ dá»¥ng:** Netflix, Apple, Airbnb, LinkedIn

---

#### 3. Apache Spark - Processing Engine

**â“ Táº¡i sao chá»n Spark mÃ  khÃ´ng dÃ¹ng Pandas hay Dask?**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SO SÃNH PROCESSING ENGINES                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     TiÃªu chÃ­     â”‚    Spark     â”‚    Pandas    â”‚         Dask           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Distributed      â”‚ âœ“ Yes        â”‚ âœ— No         â”‚ âœ“ Yes                  â”‚
â”‚ Data size        â”‚ âœ“ TB/PB      â”‚ âœ— GB only    â”‚ â–³ TB                   â”‚
â”‚ Iceberg native   â”‚ âœ“ Yes        â”‚ âœ— No         â”‚ âœ— Limited              â”‚
â”‚ SQL support      â”‚ âœ“ SparkSQL   â”‚ âœ— No         â”‚ â–³ Limited              â”‚
â”‚ ML libraries     â”‚ âœ“ MLlib      â”‚ âœ“ Sklearn    â”‚ â–³ Limited              â”‚
â”‚ Learning curve   â”‚ â–³ Medium     â”‚ âœ“ Easy       â”‚ âœ“ Easy                 â”‚
â”‚ Industry use     â”‚ âœ“ Standard   â”‚ âœ“ Common     â”‚ â–³ Growing              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âœ… Spark Ä‘Æ°á»£c chá»n vÃ¬:**
- Há»‡ thá»‘ng cáº§n xá»­ lÃ½ nhiá»u nÄƒm dá»¯ liá»‡u time-series (potentially TB scale)
- Native integration vá»›i Iceberg (MERGE INTO, time travel, etc.)
- SQL interface (SparkSQL) cho transformation
- MLlib cho machine learning pipeline
- Industry standard - nhiá»u tÃ i liá»‡u vÃ  examples

---

#### 4. Trino - SQL Query Engine

> **âš ï¸ LÆ°u Ã½:** Trino vÃ  Superset lÃ  **2 loáº¡i tool khÃ¡c nhau**:
> - **Trino** = Query Engine (cháº¡y SQL queries)
> - **Superset** = BI/Visualization Tool (táº¡o dashboard)
> 
> Hai tool nÃ y **bá»• sung cho nhau**, khÃ´ng thay tháº¿ nhau. Dá»± Ã¡n cÃ³ thá»ƒ dÃ¹ng cáº£ Trino + Superset.

**â“ Táº¡i sao chá»n Trino lÃ m Query Engine?**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SO SÃNH SQL QUERY ENGINES                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     TiÃªu chÃ­     â”‚    Trino     â”‚    Presto    â”‚       SparkSQL         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Interactive      â”‚ âœ“ Fast       â”‚ âœ“ Fast       â”‚ â–³ Slower startup       â”‚
â”‚ Iceberg support  â”‚ âœ“ Native     â”‚ âœ“ Native     â”‚ âœ“ Native               â”‚
â”‚ Power BI connect â”‚ âœ“ JDBC/ODBC  â”‚ âœ“ JDBC/ODBC  â”‚ â–³ Limited              â”‚
â”‚ Standalone       â”‚ âœ“ Yes        â”‚ âœ“ Yes        â”‚ âœ— Needs Spark cluster  â”‚
â”‚ Memory efficient â”‚ âœ“ Good       â”‚ âœ“ Good       â”‚ â–³ High memory          â”‚
â”‚ Active develop   â”‚ âœ“ Very       â”‚ â–³ Facebook   â”‚ âœ“ Apache               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âœ… Trino Ä‘Æ°á»£c chá»n vÃ¬:**
- **Fast interactive queries:** Tá»‘i Æ°u cho BI dashboards vÃ  ad-hoc analysis
- **Power BI integration:** JDBC driver cho Power BI visualization
- **Standalone service:** KhÃ´ng cáº§n cháº¡y cáº£ Spark cluster Ä‘á»ƒ query
- **Active development:** Fork tá»« Presto vá»›i nhiá»u improvements
- **Federated queries:** CÃ³ thá»ƒ query nhiá»u data sources cÃ¹ng lÃºc

**â“ Táº¡i sao dá»± Ã¡n khÃ´ng dÃ¹ng Superset?**

Thá»±c táº¿ dá»± Ã¡n sá»­ dá»¥ng **Power BI** cho visualization thay vÃ¬ Superset:

| TiÃªu chÃ­ | Power BI | Apache Superset |
|----------|----------|-----------------|
| **Enterprise features** | âœ“ Nhiá»u | â–³ Basic |
| **Ease of use** | âœ“ Drag-drop | â–³ Cáº§n há»c |
| **Trino connector** | âœ“ JDBC | âœ“ SQLAlchemy |
| **Sharing dashboards** | âœ“ Cloud | â–³ Self-hosted |
| **License** | â–³ Freemium | âœ“ Open source |

Power BI Ä‘Æ°á»£c chá»n vÃ¬ phá»• biáº¿n trong enterprise vÃ  dá»… há»c cho sinh viÃªn.

---

#### 5. PostgreSQL - Metadata Catalog

**â“ Táº¡i sao dÃ¹ng PostgreSQL JDBC Catalog thay vÃ¬ Hive Metastore?**

| TiÃªu chÃ­ | PostgreSQL JDBC | Hive Metastore |
|----------|-----------------|----------------|
| **Dependency** | âœ“ Just PostgreSQL | âœ— Hadoop ecosystem required |
| **Setup complexity** | âœ“ Simple | âœ— Complex |
| **Docker friendly** | âœ“ Single container | âœ— Multiple containers |
| **Maintenance** | âœ“ Easy | âœ— Hard |
| **Performance** | âœ“ Good | âœ“ Good |

**âœ… PostgreSQL Ä‘Æ°á»£c chá»n vÃ¬:**
- KhÃ´ng cáº§n Hadoop/Hive ecosystem
- Setup Ä‘Æ¡n giáº£n vá»›i Docker
- Dá»… maintenance vÃ  backup
- Iceberg há»— trá»£ native JDBC catalog

---

#### 6. MLflow - ML Tracking

| TiÃªu chÃ­ | MLflow | Weights & Biases | Neptune.ai |
|----------|--------|------------------|------------|
| **Open source** | âœ“ Yes | â–³ Freemium | â–³ Freemium |
| **Self-hosted** | âœ“ Yes | âœ— Cloud | âœ— Cloud |
| **Integration** | âœ“ Multi-framework | âœ“ Multi | âœ“ Multi |
| **Model registry** | âœ“ Yes | âœ“ Yes | âœ“ Yes |

**âœ… MLflow Ä‘Æ°á»£c chá»n vÃ¬:** Open source, self-hosted, tÃ­ch há»£p tá»‘t vá»›i PySpark.

---

### ğŸ“¡ Táº¡i Sao Chá»n CÃ¡c API Nguá»“n Dá»¯ Liá»‡u?

#### 1. Open-Meteo Weather API

**â“ Táº¡i sao chá»n Open-Meteo thay vÃ¬ cÃ¡c Weather API khÃ¡c?**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SO SÃNH WEATHER APIs                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     TiÃªu chÃ­     â”‚  Open-Meteo  â”‚ OpenWeather  â”‚   Weather.com (IBM)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Miá»…n phÃ­         â”‚ âœ“ 10k/day    â”‚ â–³ 1k/day     â”‚ âœ— Tráº£ phÃ­              â”‚
â”‚ Historical data  â”‚ âœ“ 1940-now   â”‚ â–³ 5 days     â”‚ â–³ Limited              â”‚
â”‚ Solar radiation  â”‚ âœ“ Detailed   â”‚ â–³ Basic      â”‚ â–³ Basic                â”‚
â”‚ Hourly data      â”‚ âœ“ Yes        â”‚ âœ“ Yes        â”‚ âœ“ Yes                  â”‚
â”‚ Timezone support â”‚ âœ“ Flexible   â”‚ â–³ UTC only   â”‚ âœ“ Flexible             â”‚
â”‚ Rate limit       â”‚ âœ“ Generous   â”‚ âœ— Strict     â”‚ âœ— Strict               â”‚
â”‚ No API key       â”‚ âœ“ Optional   â”‚ âœ— Required   â”‚ âœ— Required             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âœ… Open-Meteo Ä‘Æ°á»£c chá»n vÃ¬:**
- **Miá»…n phÃ­ vá»›i quota cao:** 10,000 requests/day Ä‘á»§ cho development
- **Historical data tá»« 1940:** CÃ³ thá»ƒ backfill nhiá»u nÄƒm dá»¯ liá»‡u
- **Solar radiation chi tiáº¿t:** `shortwave_radiation`, `direct_radiation`, `diffuse_radiation`, `direct_normal_irradiance` - critical cho solar energy forecasting
- **Timezone flexible:** CÃ³ thá»ƒ request dá»¯ liá»‡u theo local timezone cá»§a facility
- **KhÃ´ng cáº§n API key:** Dá»… dÃ ng setup vÃ  testing

**Äáº·c biá»‡t quan trá»ng cho dá»± Ã¡n:** Open-Meteo cung cáº¥p **irradiance data** (bá»©c xáº¡ máº·t trá»i) chi tiáº¿t - Ä‘Ã¢y lÃ  input chÃ­nh cho solar energy prediction model.

---

#### 2. Open-Meteo Air Quality API

**â“ Táº¡i sao cáº§n Air Quality data cho solar forecasting?**

| áº¢nh hÆ°á»Ÿng | Giáº£i thÃ­ch |
|-----------|------------|
| **PM2.5/PM10** | Bá»¥i háº¥p thá»¥ vÃ  tÃ¡n xáº¡ Ã¡nh sÃ¡ng â†’ giáº£m solar irradiance Ä‘áº¿n panel |
| **Ozone** | Háº¥p thá»¥ UV â†’ áº£nh hÆ°á»Ÿng panel efficiency |
| **UV Index** | LiÃªn quan trá»±c tiáº¿p Ä‘áº¿n solar energy potential |
| **Dust** | BÃ¡m trÃªn panel â†’ giáº£m output |

**âœ… Open-Meteo Air Quality Ä‘Æ°á»£c chá»n vÃ¬:**
- CÃ¹ng vendor vá»›i Weather API â†’ consistent data
- Miá»…n phÃ­ vÃ  cÃ³ historical data
- CÃ³ cáº£ UV index (quan trá»ng cho solar)

---

#### 3. OpenElectricity API (NEM Australia)

**â“ Táº¡i sao chá»n dá»¯ liá»‡u tá»« Australia NEM thay vÃ¬ cÃ¡c thá»‹ trÆ°á»ng khÃ¡c?**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SO SÃNH ELECTRICITY APIs                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     TiÃªu chÃ­     â”‚ OpenElectricâ”‚   EIA (US)   â”‚    Entso-E (Europe)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Solar specific   â”‚ âœ“ Yes        â”‚ â–³ Aggregated â”‚ â–³ Aggregated           â”‚
â”‚ Facility-level   â”‚ âœ“ Yes        â”‚ âœ— Regional   â”‚ âœ— Regional             â”‚
â”‚ 5-min granularityâ”‚ âœ“ Yes (we use 1h)â”‚ âœ— Hourly     â”‚ âœ— 15-min               â”‚
â”‚ Free API         â”‚ âœ“ Yes        â”‚ âœ“ Yes        â”‚ â–³ Registration         â”‚
â”‚ Real-time        â”‚ âœ“ Yes        â”‚ â–³ Delayed    â”‚ â–³ Delayed              â”‚
â”‚ Well documented  â”‚ âœ“ Yes        â”‚ âœ“ Yes        â”‚ â–³ Complex              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âœ… OpenElectricity (NEM Australia) Ä‘Æ°á»£c chá»n vÃ¬:**

1. **Facility-level data:** CÃ³ thá»ƒ query tá»«ng nhÃ  mÃ¡y solar riÃªng láº» (khÃ´ng pháº£i aggregated regional data)
   
2. **Granularity options:** TÃ¹y chá»n resolution cao nháº¥t trong cÃ¡c thá»‹ trÆ°á»ng Ä‘iá»‡n
   - US EIA: Hourly only
   - Europe: 15-minute
   - Australia NEM: 5-minute option (we use 1h for efficiency)

3. **Solar-specific facilities:** CÃ³ metadata vá» facility type (solar_utility) Ä‘á»ƒ filter chÃ­nh xÃ¡c

4. **Geographic coordinates:** CÃ³ lat/lon cá»§a tá»«ng facility â†’ matching vá»›i weather data location

5. **Clean API design:** RESTful API dá»… integrate, well-documented

6. **Australia solar market:** One of the largest solar markets globally
   - High solar penetration (~30% of electricity mix in some states)
   - Diverse climate zones (tropical to desert to temperate)
   - Good variety of conditions for ML training

**VÃ­ dá»¥ facility data cÃ³ Ä‘Æ°á»£c:**
```python
{
    "facility_code": "NYNGAN",
    "facility_name": "Nyngan Solar Plant",
    "network_region": "NSW1",
    "location_lat": -31.5520,
    "location_lng": 147.1930,
    "total_capacity_mw": 102.0,
    "fueltech": "solar_utility"
}
```

---

### ğŸ“Š Tá»•ng Káº¿t Lá»±a Chá»n CÃ´ng Nghá»‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TECHNOLOGY STACK SUMMARY                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ğŸ“¥ DATA SOURCES                    ğŸ  DATA LAKEHOUSE                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Open-Meteo      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚       MinIO (S3)        â”‚         â”‚
â”‚  â”‚ â€¢ Weather       â”‚               â”‚   Object Storage        â”‚         â”‚
â”‚  â”‚ â€¢ Air Quality   â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚                        â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   Apache Iceberg        â”‚         â”‚
â”‚  â”‚ OpenElectricity â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   Table Format          â”‚         â”‚
â”‚  â”‚ â€¢ Energy (MWh)  â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â”‚ â€¢ Power (MW)    â”‚                           â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚                                    â”‚   Apache Spark          â”‚         â”‚
â”‚                                    â”‚   Processing Engine     â”‚         â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                â”‚                        â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                     â–¼                          â–¼                      â–¼ â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚         â”‚     Trino       â”‚      â”‚    Power BI     â”‚    â”‚   MLflow   â”‚ â”‚
â”‚         â”‚  Query Engine   â”‚      â”‚  Visualization  â”‚    â”‚ ML Trackingâ”‚ â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---



## 1ï¸âƒ£ CÃ€I Äáº¶T VÃ€ Cáº¤U HÃŒNH CÃ”NG NGHá»†/Há»† THá»NG

### ğŸ—ï¸ Kiáº¿n TrÃºc Data Lakehouse

Há»‡ thá»‘ng Ä‘Æ°á»£c xÃ¢y dá»±ng theo kiáº¿n trÃºc **Medallion (Bronze â†’ Silver â†’ Gold)** vá»›i cÃ¡c cÃ´ng nghá»‡:

![Kiáº¿n trÃºc Data Lakehouse](/home/pvlakehouse/.gemini/antigravity/brain/99ffe7f2-0ab6-4d23-91e8-f1636b5f8228/uploaded_image_1_1766391685934.png)

### ğŸ’» Stack CÃ´ng Nghá»‡

| ThÃ nh pháº§n | CÃ´ng nghá»‡ | Má»¥c Ä‘Ã­ch |
|-----------|-----------|----------|
| **Object Storage** | MinIO | LÆ°u trá»¯ S3-compatible cho data lake |
| **Table Format** | Apache Iceberg v2 | ACID transactions, time travel, schema evolution |
| **Batch Processing** | Apache Spark 3.5 | Engine xá»­ lÃ½ dá»¯ liá»‡u phÃ¢n tÃ¡n |
| **Query Engine** | Trino | SQL analytics engine |
| **ML Tracking** | MLflow 2.4 | Experiment tracking & model registry |
| **Metadata Store** | PostgreSQL | Iceberg catalog & application metadata |
| **Container** | Docker + Docker Compose | Containerization & orchestration |

### ğŸ“ Cáº¥u TrÃºc Docker

**File cáº¥u hÃ¬nh chÃ­nh:** [docker-compose.yml](file:///home/pvlakehouse/dlh-pv/docker/docker-compose.yml)

#### Services Ä‘Æ°á»£c cáº¥u hÃ¬nh:

```yaml
services:
  minio:          # Object storage S3-compatible
  mc:             # MinIO client Ä‘á»ƒ setup buckets/policies
  postgres:       # Database cho Iceberg catalog
  pgadmin:        # PostgreSQL admin UI
  spark-master:   # Spark Master node
  spark-worker:   # Spark Worker node
  trino:          # SQL query engine
  mlflow:         # ML experiment tracking
```

#### Docker Compose Profiles:

| Profile | Services | Use Case |
|---------|----------|----------|
| `core` | MinIO, PostgreSQL, Spark, Trino, pgAdmin | Data engineering workloads |
| `ml` | MLflow | Machine learning workflows |

### ğŸ”§ Cáº¥u HÃ¬nh Chi Tiáº¿t

#### 1. MinIO Configuration (Object Storage)
```yaml
minio:
  image: minio/minio
  command: server /data --console-address ":9001"
  ports:
    - "9000:9000"   # API port
    - "9001:9001"   # Console port
  volumes:
    - minio-data:/data
```

**Buckets Ä‘Æ°á»£c táº¡o tá»± Ä‘á»™ng:**
- `lakehouse` - Data warehouse storage
- `mlflow` - MLflow artifacts storage

**Policies:**
- `lakehouse-rw` - Read/write cho Spark vÃ  Trino
- `mlflow-rw` - MLflow artifacts access

#### 2. Spark Cluster Configuration

**File:** [docker/spark/Dockerfile](file:///home/pvlakehouse/dlh-pv/docker/spark/Dockerfile)

```dockerfile
# Custom Spark image with S3A support
FROM spark:3.5.0
# Include hadoop-aws and AWS SDK for S3A
```

**Cáº¥u hÃ¬nh Spark cho Iceberg:**
- JDBC Catalog vá»›i PostgreSQL
- S3A filesystem cho MinIO
- Custom `core-site.xml` cho S3 connectivity

#### 3. Trino Configuration

**Iceberg Catalog:** [trino/catalog/iceberg.properties](file:///home/pvlakehouse/dlh-pv/docker/trino/catalog/iceberg.properties.template)

```properties
connector.name=iceberg
iceberg.catalog.type=jdbc
iceberg.jdbc-catalog.catalog-name=iceberg
iceberg.jdbc-catalog.connection-url=jdbc:postgresql://postgres:5432/iceberg_catalog
iceberg.fs.native-s3.enabled=true
```

#### 4. PostgreSQL Databases

| Database | Purpose |
|----------|---------|
| `iceberg` | Application data |
| `iceberg_catalog` | Iceberg table metadata |
| `mlflow` | MLflow experiment tracking |

### ğŸš€ Lá»‡nh Khá»Ÿi Äá»™ng Há»‡ Thá»‘ng

```bash
# Clone repository
git clone https://github.com/xuanquangIT/dlh-pv.git
cd dlh-pv

# Copy environment template
cp docker/.env.example docker/.env

# Start core services
cd docker
docker compose --profile core up -d

# Start ML services (optional)
docker compose --profile ml up -d

# Verify health
./scripts/health-check.sh
```

### ğŸŒ Access Web Interfaces

| Service | URL | Credentials |
|---------|-----|-------------|
| MinIO Console | http://localhost:9001 | `pvlakehouse` / `pvlakehouse` |
| Spark Master UI | http://localhost:8080 | â€” |
| Trino UI | http://localhost:8081 | â€” |
| MLflow UI | http://localhost:5000 | â€” |
| pgAdmin | http://localhost:5050 | `admin@admin.com` / `pvlakehouse` |

---

## 2ï¸âƒ£ NGHIÃŠN Cá»¨U NGUá»’N Dá»® LIá»†U Äáº¦U VÃ€O

### ğŸ“Š Tá»•ng Quan Nguá»“n Dá»¯ Liá»‡u

![Luá»“ng dá»¯ liá»‡u Bronze-Silver-Gold](/home/pvlakehouse/.gemini/antigravity/brain/99ffe7f2-0ab6-4d23-91e8-f1636b5f8228/uploaded_image_0_1766391685934.png)

Há»‡ thá»‘ng sá»­ dá»¥ng **3 nguá»“n dá»¯ liá»‡u API** tá»« bÃªn ngoÃ i:

### ğŸ“¡ Nguá»“n 1: Open-Meteo Weather API

**API Client:** [openmeteo.py](file:///home/pvlakehouse/dlh-pv/src/pv_lakehouse/etl/clients/openmeteo.py)

| Äáº·c Ä‘iá»ƒm | Chi tiáº¿t |
|----------|----------|
| **Website** | https://open-meteo.com |
| **Endpoint** | Historical + Forecast API |
| **Rate Limit** | 10,000 requests/day (free tier) |
| **Timezone** | Local time (configurable) |
| **Frequency** | Hourly |
| **Coverage** | 1940-present (historical), 16 days forecast |

**CÃ¡c biáº¿n thá»i tiáº¿t Ä‘Æ°á»£c thu tháº­p:**
```python
DEFAULT_WEATHER_VARS = (
    "shortwave_radiation,direct_radiation,diffuse_radiation,"
    "direct_normal_irradiance,terrestrial_radiation,temperature_2m,"
    "dew_point_2m,cloud_cover,cloud_cover_low,cloud_cover_mid,"
    "cloud_cover_high,precipitation,is_day,sunshine_duration,"
    "total_column_integrated_water_vapour,boundary_layer_height,"
    "wet_bulb_temperature_2m,wind_speed_10m,wind_direction_10m,"
    "pressure_msl,wind_gusts_10m"
)
```

### ğŸ“¡ Nguá»“n 2: Open-Meteo Air Quality API

| Äáº·c Ä‘iá»ƒm | Chi tiáº¿t |
|----------|----------|
| **Endpoint** | https://air-quality-api.open-meteo.com/v1/air-quality |
| **Frequency** | Hourly |
| **Coverage** | 2+ years historical, 5 days forecast |
| **Max Days per Request** | 14 days |

**CÃ¡c biáº¿n cháº¥t lÆ°á»£ng khÃ´ng khÃ­:**
```python
DEFAULT_AIR_VARS = (
    "pm2_5,pm10,dust,nitrogen_dioxide,ozone,"
    "sulphur_dioxide,carbon_monoxide,uv_index,uv_index_clear_sky"
)
```

### ğŸ“¡ Nguá»“n 3: OpenElectricity API (NEM Australia)

**API Client:** [openelectricity.py](file:///home/pvlakehouse/dlh-pv/src/pv_lakehouse/etl/clients/openelectricity.py)

| Äáº·c Ä‘iá»ƒm | Chi tiáº¿t |
|----------|----------|
| **Website** | https://openelectricity.org.au |
| **Market** | NEM (National Electricity Market) - Australia |
| **Granularity** | Supports 5m/1h/1d/... (we use **1h**) |
| **Timezone** | **UTC** (cáº§n convert) |
| **Coverage** | 2+ years historical |
| **Metrics** | Energy (MWh), Power (MW) |

**Supported intervals:**
```python
SUPPORTED_INTERVALS = {"5m", "1h", "1d", "7d", "1M", "3M", "season", "1y", "fy"}
```

### ğŸ­ Danh SÃ¡ch Facilities (NhÃ  MÃ¡y Äiá»‡n Máº·t Trá»i)

**File cáº¥u hÃ¬nh:** [facilities.js](file:///home/pvlakehouse/dlh-pv/src/pv_lakehouse/etl/bronze/facilities.js)

CÃ¡c nhÃ  mÃ¡y Ä‘iá»‡n máº·t trá»i trong thá»‹ trÆ°á»ng NEM Australia Ä‘Æ°á»£c thu tháº­p dá»¯ liá»‡u.

### ğŸ• Timezone Handling - Quan Trá»ng

| Data Type | Bronze Timestamp | Timezone Format | Cáº§n Convert á»Ÿ Silver? |
|-----------|-----------------|-----------------|----------------------|
| **Energy** | `interval_ts` | **UTC** | âœ… Cáº§n convert sang local |
| **Weather** | `weather_timestamp` | **Local time** | âŒ KhÃ´ng cáº§n |
| **Air Quality** | `air_timestamp` | **Local time** | âŒ KhÃ´ng cáº§n |

**Australian Timezones:**

| State | Timezone | UTC Offset | DST? |
|-------|----------|------------|------|
| NSW, VIC, TAS | `Australia/Sydney` | +10 / +11 | Yes |
| QLD | `Australia/Brisbane` | +10 | No |
| SA | `Australia/Adelaide` | +9:30 / +10:30 | Yes |
| WA | `Australia/Perth` | +8 | No |
| NT | `Australia/Darwin` | +9:30 | No |

---

## 3ï¸âƒ£ THá»°C HIá»†N Náº P Dá»® LIá»†U VÃ€O Lá»šP BRONZE

### ğŸ“‚ Cáº¥u TrÃºc ThÆ° Má»¥c Bronze

```
src/pv_lakehouse/etl/bronze/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ facilities.js               # Hardcoded facility coordinates
â”œâ”€â”€ facility_timezones.py       # Timezone mapping per facility
â”œâ”€â”€ load_facilities.py          # Load facility master data
â”œâ”€â”€ load_facility_weather.py    # Weather ingestion job
â”œâ”€â”€ load_facility_timeseries.py # Energy ingestion job
â”œâ”€â”€ load_facility_air_quality.py# Air quality ingestion job
â””â”€â”€ openmeteo_common.py         # Shared Open-Meteo utilities
```

### ğŸ“Š 3.1 Bronze Weather Table

**Loader:** [load_facility_weather.py](file:///home/pvlakehouse/dlh-pv/src/pv_lakehouse/etl/bronze/load_facility_weather.py)

**Table:** `lh.bronze.raw_facility_weather`

#### Schema:

| Column | Type | MÃ´ Táº£ | ÄÆ¡n Vá»‹ |
|--------|------|-------|--------|
| `facility_code` | string | MÃ£ facility (VD: NYNGAN) | - |
| `facility_name` | string | TÃªn facility | - |
| `weather_timestamp` | timestamp | **Local time** tá»« API | - |
| `shortwave_radiation` | double | Bá»©c xáº¡ sÃ³ng ngáº¯n tá»•ng | W/mÂ² |
| `direct_radiation` | double | Bá»©c xáº¡ trá»±c tiáº¿p (beam) | W/mÂ² |
| `diffuse_radiation` | double | Bá»©c xáº¡ khuáº¿ch tÃ¡n (scattered) | W/mÂ² |
| `direct_normal_irradiance` | double | DNI - Bá»©c xáº¡ phÃ¡p tuyáº¿n | W/mÂ² |
| `temperature_2m` | double | Nhiá»‡t Ä‘á»™ táº¡i 2m | Â°C |
| `dew_point_2m` | double | Äiá»ƒm sÆ°Æ¡ng | Â°C |
| `wet_bulb_temperature_2m` | double | Nhiá»‡t Ä‘á»™ bÃ³ng Æ°á»›t | Â°C |
| `cloud_cover` | double | MÃ¢y tá»•ng | % |
| `cloud_cover_low` | double | MÃ¢y táº§ng tháº¥p (<2km) | % |
| `cloud_cover_mid` | double | MÃ¢y táº§ng trung (2-6km) | % |
| `cloud_cover_high` | double | MÃ¢y táº§ng cao (>6km) | % |
| `precipitation` | double | LÆ°á»£ng mÆ°a | mm |
| `sunshine_duration` | double | Thá»i gian náº¯ng trong giá» | seconds |
| `total_column_integrated_water_vapour` | double | HÆ¡i nÆ°á»›c cá»™t tá»•ng | kg/mÂ² |
| `wind_speed_10m` | double | Tá»‘c Ä‘á»™ giÃ³ táº¡i 10m | m/s |
| `wind_direction_10m` | double | HÆ°á»›ng giÃ³ (0=N, 90=E) | degrees |
| `wind_gusts_10m` | double | GiÃ³ giáº­t | m/s |
| `pressure_msl` | double | Ãp suáº¥t má»±c nÆ°á»›c biá»ƒn | hPa |

#### Ká»¹ Thuáº­t Xá»­ LÃ½:

##### ğŸ”¹ Pháº§n 1: ThreadPoolExecutor - Xá»­ LÃ½ Song Song

```python
# Sá»­ dá»¥ng ThreadPoolExecutor cho concurrent fetching
with ThreadPoolExecutor(max_workers=args.max_workers) as executor:
    futures = {executor.submit(fetch_for_facility, facility): facility 
               for facility in facilities}
```

**Giáº£i thÃ­ch tá»«ng dÃ²ng:**

| DÃ²ng | Code | Giáº£i thÃ­ch |
|------|------|------------|
| 1 | `with ThreadPoolExecutor(...)` | Táº¡o thread pool vá»›i sá»‘ lÆ°á»£ng workers tá»‘i Ä‘a |
| 2 | `max_workers=args.max_workers` | Sá»‘ threads cháº¡y song song (VD: 4 threads) |
| 3 | `executor.submit(...)` | Gá»­i task vÃ o thread pool Ä‘á»ƒ cháº¡y async |
| 4 | `fetch_for_facility, facility` | HÃ m fetch + tham sá»‘ facility |
| 5 | `{...}: facility` | Dictionary mapping future â†’ facility Ä‘á»ƒ track |

**Táº¡i sao cáº§n ThreadPoolExecutor?**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  KHÃ”NG cÃ³ ThreadPoolExecutor (Sequential):                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
â”‚  Facility 1 â”€â”€â”€â”€â–º[2s]â”€â”€â”€â”€â–º Facility 2 â”€â”€â”€â”€â–º[2s]â”€â”€â”€â”€â–º ... (10 facilities)â”‚
â”‚  Tá»•ng thá»i gian: 2s Ã— 10 = 20 giÃ¢y                                     â”‚
â”‚                                                                         â”‚
â”‚  CÃ“ ThreadPoolExecutor (Parallel 4 threads):                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                             â”‚
â”‚  Thread 1: Facility 1 â”€â”€â”€â”€â–º[2s]â”€â”€â”€â”€â–º Facility 5 â”€â”€â”€â”€â–º[2s]â”€â”€â”€â”€â–º         â”‚
â”‚  Thread 2: Facility 2 â”€â”€â”€â”€â–º[2s]â”€â”€â”€â”€â–º Facility 6 â”€â”€â”€â”€â–º[2s]â”€â”€â”€â”€â–º         â”‚
â”‚  Thread 3: Facility 3 â”€â”€â”€â”€â–º[2s]â”€â”€â”€â”€â–º Facility 7 â”€â”€â”€â”€â–º[2s]â”€â”€â”€â”€â–º         â”‚
â”‚  Thread 4: Facility 4 â”€â”€â”€â”€â–º[2s]â”€â”€â”€â”€â–º Facility 8 â”€â”€â”€â”€â–º[2s]â”€â”€â”€â”€â–º         â”‚
â”‚  Tá»•ng thá»i gian: ~6 giÃ¢y (3 batches Ã— 2s)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

##### ğŸ”¹ Pháº§n 2: Rate Limiter - Chá»‘ng API Throttling

```python
# Rate limiting Ä‘á»ƒ trÃ¡nh API throttling
limiter = RateLimiter(30.0)  # 30 requests/minute
```

**Giáº£i thÃ­ch:**

| Code | Giáº£i thÃ­ch |
|------|------------|
| `RateLimiter(30.0)` | Giá»›i háº¡n tá»‘i Ä‘a 30 requests má»—i phÃºt |
| `limiter.wait()` | Chá» Ä‘áº¿n khi Ä‘Æ°á»£c phÃ©p gá»i tiáº¿p |

**Táº¡i sao cáº§n Rate Limiter?**
- API cÃ³ giá»›i háº¡n requests (VD: Open-Meteo 10,000/day)
- Náº¿u gá»i quÃ¡ nhanh â†’ bá»‹ block (HTTP 429 Too Many Requests)
- Rate limiter tá»± Ä‘á»™ng delay giá»¯a cÃ¡c requests

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  KHÃ”NG cÃ³ Rate Limiter:                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
â”‚  t=0s: Request 1 âœ“                                                     â”‚
â”‚  t=0.001s: Request 2 âœ“                                                 â”‚
â”‚  t=0.002s: Request 3 â†’ HTTP 429 ERROR (Too Many Requests)              â”‚
â”‚                                                                         â”‚
â”‚  CÃ“ Rate Limiter (30/min = 2s interval):                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                 â”‚
â”‚  t=0s: Request 1 âœ“                                                     â”‚
â”‚  t=2s: Request 2 âœ“                                                     â”‚
â”‚  t=4s: Request 3 âœ“                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

##### ğŸ”¹ Pháº§n 3: MERGE INTO - Upsert vÃ  Deduplicate

```sql
MERGE INTO lh.bronze.raw_facility_weather AS target
USING (
    SELECT * FROM (
        SELECT *,
        ROW_NUMBER() OVER (PARTITION BY facility_code, weather_timestamp 
                          ORDER BY ingest_timestamp DESC) as rn
        FROM weather_source
    ) WHERE rn = 1
) AS source
ON target.facility_code = source.facility_code 
   AND target.weather_timestamp = source.weather_timestamp
WHEN MATCHED THEN UPDATE SET *
WHEN NOT MATCHED THEN INSERT *
```

**Giáº£i thÃ­ch tá»«ng pháº§n:**

**ğŸ“Œ BÆ°á»›c 1: XÃ¡c Ä‘á»‹nh báº£ng Ä‘Ã­ch**
```sql
MERGE INTO lh.bronze.raw_facility_weather AS target
```
| Code | Giáº£i thÃ­ch |
|------|------------|
| `MERGE INTO` | Lá»‡nh SQL Ä‘á»ƒ UPDATE hoáº·c INSERT tÃ¹y Ä‘iá»u kiá»‡n |
| `lh.bronze.raw_facility_weather` | Báº£ng Ä‘Ã­ch trong Iceberg (catalog.schema.table) |
| `AS target` | Äáº·t alias "target" cho báº£ng Ä‘Ã­ch |

**ğŸ“Œ BÆ°á»›c 2: Chuáº©n bá»‹ dá»¯ liá»‡u nguá»“n (cÃ³ deduplicate)**
```sql
USING (
    SELECT * FROM (
        SELECT *,
        ROW_NUMBER() OVER (PARTITION BY facility_code, weather_timestamp 
                          ORDER BY ingest_timestamp DESC) as rn
        FROM weather_source
    ) WHERE rn = 1
) AS source
```

| Code | Giáº£i thÃ­ch |
|------|------------|
| `USING (...)` | Äá»‹nh nghÄ©a dá»¯ liá»‡u nguá»“n Ä‘á»ƒ merge |
| `ROW_NUMBER() OVER (...)` | ÄÃ¡nh sá»‘ thá»© tá»± cÃ¡c dÃ²ng trong má»—i partition |
| `PARTITION BY facility_code, weather_timestamp` | NhÃ³m cÃ¡c dÃ²ng cÃ³ cÃ¹ng facility + timestamp |
| `ORDER BY ingest_timestamp DESC` | Sáº¯p xáº¿p theo thá»i gian ingest má»›i nháº¥t trÆ°á»›c |
| `WHERE rn = 1` | Chá»‰ láº¥y dÃ²ng má»›i nháº¥t trong má»—i nhÃ³m (loáº¡i duplicate) |

**VÃ­ dá»¥ cÃ¡ch deduplicate hoáº¡t Ä‘á»™ng:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dá»® LIá»†U Gá»C (cÃ³ duplicates):                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ facility_codeâ”‚   timestamp  â”‚ temperature  â”‚ingest_tsâ”‚   rn  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NYNGAN       â”‚ 2025-01-01   â”‚ 25.0         â”‚ 08:00  â”‚   2   â”‚
â”‚ NYNGAN       â”‚ 2025-01-01   â”‚ 25.5         â”‚ 09:00  â”‚   1 âœ“ â”‚â† Giá»¯ láº¡i (má»›i nháº¥t)
â”‚ NYNGAN       â”‚ 2025-01-02   â”‚ 28.0         â”‚ 08:00  â”‚   1 âœ“ â”‚â† Chá»‰ cÃ³ 1 dÃ²ng
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SAU KHI DEDUPLICATE (WHERE rn = 1):                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NYNGAN       â”‚ 2025-01-01   â”‚ 25.5         â”‚ 09:00  â”‚   1   â”‚
â”‚ NYNGAN       â”‚ 2025-01-02   â”‚ 28.0         â”‚ 08:00  â”‚   1   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“Œ BÆ°á»›c 3: Äiá»u kiá»‡n match**
```sql
ON target.facility_code = source.facility_code 
   AND target.weather_timestamp = source.weather_timestamp
```

| Code | Giáº£i thÃ­ch |
|------|------------|
| `ON ...` | Äiá»u kiá»‡n Ä‘á»ƒ xÃ¡c Ä‘á»‹nh dÃ²ng "match" |
| Target cÃ³ dÃ²ng vá»›i cÃ¹ng `facility_code` VÃ€ `weather_timestamp` â†’ **MATCHED** |
| Target KHÃ”NG cÃ³ dÃ²ng tÆ°Æ¡ng á»©ng â†’ **NOT MATCHED** |

**ğŸ“Œ BÆ°á»›c 4: HÃ nh Ä‘á»™ng khi match/not match**
```sql
WHEN MATCHED THEN UPDATE SET *
WHEN NOT MATCHED THEN INSERT *
```

| Code | Giáº£i thÃ­ch |
|------|------------|
| `WHEN MATCHED THEN UPDATE SET *` | Náº¿u Ä‘Ã£ tá»“n táº¡i â†’ Cáº¬P NHáº¬T toÃ n bá»™ cá»™t |
| `WHEN NOT MATCHED THEN INSERT *` | Náº¿u chÆ°a tá»“n táº¡i â†’ THÃŠM Má»šI |

**Flow tá»•ng thá»ƒ:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MERGE INTO FLOW                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  1. Äá»c dá»¯ liá»‡u má»›i tá»« API â†’ DataFrame                                 â”‚
â”‚  2. Deduplicate trong DataFrame (ROW_NUMBER + WHERE rn=1)               â”‚
â”‚  3. So sÃ¡nh vá»›i báº£ng hiá»‡n táº¡i (ON condition)                           â”‚
â”‚  4. Vá»›i má»—i dÃ²ng nguá»“n:                                                 â”‚
â”‚     â””â”€â”€ TÃ¬m tháº¥y trong target? â”€â”¬â”€ CÃ“ â†’ UPDATE                         â”‚
â”‚                                 â””â”€ KHÃ”NG â†’ INSERT                       â”‚
â”‚  5. Commit transaction                                                  â”‚
â”‚                                                                         â”‚
â”‚  Káº¾T QUáº¢: Báº£ng Bronze luÃ´n cÃ³ dá»¯ liá»‡u má»›i nháº¥t, khÃ´ng trÃ¹ng            â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---


### ğŸ“Š 3.2 Bronze Energy Table

**Loader:** [load_facility_timeseries.py](file:///home/pvlakehouse/dlh-pv/src/pv_lakehouse/etl/bronze/load_facility_timeseries.py)

**Table:** `lh.bronze.raw_facility_timeseries`

#### Schema:

| Column | Type | MÃ´ Táº£ | ÄÆ¡n Vá»‹ |
|--------|------|-------|--------|
| `facility_code` | string | MÃ£ facility | - |
| `facility_name` | string | TÃªn facility | - |
| `network_code` | string | MÃ£ thá»‹ trÆ°á»ng (NEM) | - |
| `network_region` | string | VÃ¹ng (NSW1, QLD1, VIC1...) | - |
| `metric` | string | Loáº¡i: "energy" hoáº·c "power" | - |
| `value` | double | GiÃ¡ trá»‹ sá»‘ | MWh hoáº·c MW |
| `interval_ts` | timestamp | **UTC timestamp** | - |

#### Energy vs Power:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ENERGY (MWh) vs POWER (MW)                                     â”‚
â”‚                                                                  â”‚
â”‚  Power (MW): CÃ´ng suáº¥t tá»©c thá»i                                 â”‚
â”‚  - Táº¡i thá»i Ä‘iá»ƒm t, facility Ä‘ang phÃ¡t 50 MW                    â”‚
â”‚  - Äo: Äiá»‡n Ã¡p Ã— DÃ²ng Ä‘iá»‡n                                      â”‚
â”‚                                                                  â”‚
â”‚  Energy (MWh): NÄƒng lÆ°á»£ng tÃ­ch lÅ©y trong khoáº£ng thá»i gian       â”‚
â”‚  - Trong 5 phÃºt [t, t+5min), facility phÃ¡t 4.17 MWh             â”‚
â”‚  - Energy = Power Ã— Time = 50 MW Ã— (5/60) h = 4.17 MWh          â”‚
â”‚                                                                  â”‚
â”‚  Quan há»‡: Energy = âˆ« Power dt                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“Š 3.3 Bronze Air Quality Table

**Loader:** [load_facility_air_quality.py](file:///home/pvlakehouse/dlh-pv/src/pv_lakehouse/etl/bronze/load_facility_air_quality.py)

**Table:** `lh.bronze.raw_facility_air_quality`

#### Schema:

| Column | Type | MÃ´ Táº£ | ÄÆ¡n Vá»‹ |
|--------|------|-------|--------|
| `facility_code` | string | MÃ£ facility | - |
| `facility_name` | string | TÃªn facility | - |
| `air_timestamp` | timestamp | **Local time** tá»« API | - |
| `pm2_5` | double | Bá»¥i má»‹n PM2.5 | Âµg/mÂ³ |
| `pm10` | double | Bá»¥i PM10 | Âµg/mÂ³ |
| `dust` | double | Bá»¥i tá»•ng | Âµg/mÂ³ |
| `nitrogen_dioxide` | double | NOâ‚‚ | Âµg/mÂ³ |
| `ozone` | double | Oâ‚ƒ | Âµg/mÂ³ |
| `sulphur_dioxide` | double | SOâ‚‚ | Âµg/mÂ³ |
| `carbon_monoxide` | double | CO | mg/mÂ³ |
| `uv_index` | double | Chá»‰ sá»‘ UV | 0-11+ |
| `uv_index_clear_sky` | double | UV khi trá»i quang | 0-11+ |

### ğŸ”„ Incremental vs Backfill Mode

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  INCREMENTAL MODE (Default)                                     â”‚
â”‚                                                                  â”‚
â”‚  1. Query: SELECT MAX(timestamp) FROM bronze.table              â”‚
â”‚  2. If max_ts = NULL â†’ start = today - 1 day (first run)        â”‚
â”‚  3. If max_ts < today â†’ start = max_ts (continue from last)     â”‚
â”‚  4. If max_ts >= today â†’ reload today (update latest hours)     â”‚
â”‚  5. Fetch [start, today] â†’ append to Iceberg                    â”‚
â”‚                                                                  â”‚
â”‚  âœ“ Æ¯u: Chá»‰ load dá»¯ liá»‡u má»›i, tiáº¿t kiá»‡m API calls                â”‚
â”‚  âœ— NhÆ°á»£c: Pháº£i duy trÃ¬ state                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BACKFILL MODE                                                  â”‚
â”‚                                                                  â”‚
â”‚  1. User chá»‰ Ä‘á»‹nh: --start YYYY-MM-DD --end YYYY-MM-DD          â”‚
â”‚  2. Fetch táº¥t cáº£ dá»¯ liá»‡u trong range                            â”‚
â”‚  3. Write append hoáº·c overwrite (tÃ¹y option)                    â”‚
â”‚                                                                  â”‚
â”‚  âœ“ Æ¯u: Rebuild toÃ n bá»™ dá»¯ liá»‡u lá»‹ch sá»­                          â”‚
â”‚  âœ— NhÆ°á»£c: Tá»‘n API calls, tá»‘n thá»i gian                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸš€ Lá»‡nh Cháº¡y Bronze Jobs

```bash
# Weather - Incremental (default)
docker compose -f docker/docker-compose.yml exec spark-master \
  spark-submit --master spark://spark-master:7077 \
  /opt/workdir/src/pv_lakehouse/etl/bronze/load_facility_weather.py

# Weather - Backfill specific dates
docker compose -f docker/docker-compose.yml exec spark-master \
  spark-submit --master spark://spark-master:7077 \
  /opt/workdir/src/pv_lakehouse/etl/bronze/load_facility_weather.py \
  --start 2025-01-01 --end 2025-01-31 --mode backfill

# Energy - Incremental
docker compose -f docker/docker-compose.yml exec spark-master \
  spark-submit --master spark://spark-master:7077 \
  /opt/workdir/src/pv_lakehouse/etl/bronze/load_facility_timeseries.py

# Air Quality - Incremental
docker compose -f docker/docker-compose.yml exec spark-master \
  spark-submit --master spark://spark-master:7077 \
  /opt/workdir/src/pv_lakehouse/etl/bronze/load_facility_air_quality.py
```

---

## 4ï¸âƒ£ Xá»¬ LÃ, LÃ€M Sáº CH VÃ€ CHUáº¨N HOÃ Dá»® LIá»†U á» Lá»šP SILVER

### ğŸ“‚ Cáº¥u TrÃºc ThÆ° Má»¥c Silver

```
src/pv_lakehouse/etl/silver/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ base.py                  # BaseSilverLoader class
â”œâ”€â”€ cli.py                   # Command-line interface
â”œâ”€â”€ hourly_energy.py         # Energy loader
â”œâ”€â”€ hourly_weather.py        # Weather loader  
â”œâ”€â”€ hourly_air_quality.py    # Air quality loader
â””â”€â”€ facility_master.py       # Facility master loader
```

### ğŸ—ï¸ Base Loader Architecture

**File:** [base.py](file:///home/pvlakehouse/dlh-pv/src/pv_lakehouse/etl/silver/base.py)

```python
class BaseSilverLoader:
    bronze_table: str           # Source table
    silver_table: str           # Target table
    timestamp_column: str       # Bronze timestamp column
    partition_cols: tuple       # Partition columns
    
    def _get_hour_offset(self) -> int:
        """Return hour offset for timestamp shift."""
        return 0  # Default: no shift
    
    def _get_timezone_lookback_hours(self) -> int:
        """Return timezone lookback hours."""
        return MAX_TIMEZONE_OFFSET_HOURS  # Default: 12h
    
    def run(self) -> int:
        bronze_df = self._read_bronze()
        return self._process_in_chunks(bronze_df, chunk_days=7)
```

### ğŸ¯ Quality Flags System

| Flag | MÃ´ Táº£ | Xá»­ LÃ½ |
|------|-------|-------|
| **GOOD** | Dá»¯ liá»‡u há»£p lá»‡, pass táº¥t cáº£ checks | Weight = 1.0 trong ML training |
| **WARNING** | Soft check failed, cÃ³ thá»ƒ lÃ  edge case | Weight = 0.5 trong ML training |
| **BAD** | Hard bounds violated, dá»¯ liá»‡u invalid | Exclude khá»i ML training |

### âš¡ 4.1 Silver Hourly Energy

**Loader:** [hourly_energy.py](file:///home/pvlakehouse/dlh-pv/src/pv_lakehouse/etl/silver/hourly_energy.py)

**Source:** `lh.bronze.raw_facility_timeseries`  
**Target:** `lh.silver.clean_hourly_energy`

#### Schema:

| Column | Type | MÃ´ Táº£ |
|--------|------|-------|
| `facility_code` | string | MÃ£ facility |
| `facility_name` | string | TÃªn facility |
| `network_code` | string | MÃ£ thá»‹ trÆ°á»ng (NEM) |
| `network_region` | string | VÃ¹ng (NSW1, QLD1...) |
| `date_hour` | timestamp | Giá» trÃ²n (local time, **partition key**) |
| `energy_mwh` | double | NÄƒng lÆ°á»£ng sinh ra (MWh) |
| `intervals_count` | int | Sá»‘ intervals trong giá» |
| `completeness_pct` | double | % completeness |
| `quality_flag` | string | GOOD / WARNING / BAD |
| `quality_issues` | string | Pipe-separated issues |
| `created_at` | timestamp | Thá»i gian táº¡o |
| `updated_at` | timestamp | Thá»i gian cáº­p nháº­t |

#### Timezone Conversion (UTC â†’ Local):

```python
# Bronze interval_ts lÃ  UTC
# Cáº§n convert sang facility local timezone trÆ°á»›c khi aggregate

default_local = F.from_utc_timestamp(F.col("interval_ts"), DEFAULT_TIMEZONE)
tz_expr = default_local

for code, tz in FACILITY_TIMEZONES.items():
    tz_expr = F.when(
        F.col("facility_code") == code,
        F.from_utc_timestamp(F.col("interval_ts"), tz)
    ).otherwise(tz_expr)

# VÃ­ dá»¥:
# Bronze: 2025-12-03 22:00 UTC
# â†’ Sydney (AEDT +11): 2025-12-04 09:00 local
# â†’ Brisbane (AEST +10): 2025-12-04 08:00 local
```

**Giáº£i thÃ­ch tá»«ng dÃ²ng:**

| DÃ²ng | Code | Giáº£i thÃ­ch |
|------|------|------------|
| 1 | `F.from_utc_timestamp(...)` | HÃ m PySpark chuyá»ƒn UTC â†’ local timezone |
| 2 | `F.col("interval_ts")` | Láº¥y cá»™t timestamp tá»« Bronze (Ä‘ang lÃ  UTC) |
| 3 | `DEFAULT_TIMEZONE` | "Australia/Sydney" - timezone máº·c Ä‘á»‹nh |
| 4 | `for code, tz in FACILITY_TIMEZONES.items()` | Duyá»‡t qua mapping facility â†’ timezone |
| 5 | `F.when(...).otherwise(...)` | Äiá»u kiá»‡n IF-ELSE trong Spark |
| 6 | `F.col("facility_code") == code` | Kiá»ƒm tra facility cÃ³ trong mapping |

**Diagram quÃ¡ trÃ¬nh chuyá»ƒn Ä‘á»•i:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TIMEZONE CONVERSION FLOW                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Bronze Data (UTC):                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚  facility  â”‚      interval_ts        â”‚                               â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                               â”‚
â”‚  â”‚  NYNGAN    â”‚  2025-12-03 22:00 UTC  â”‚                               â”‚
â”‚  â”‚  CLERMONT  â”‚  2025-12-03 22:00 UTC  â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                      â”‚                                                  â”‚
â”‚                      â–¼                                                  â”‚
â”‚  FACILITY_TIMEZONES = {                                                 â”‚
â”‚    "NYNGAN": "Australia/Sydney",      # NSW â†’ +11 AEDT                 â”‚
â”‚    "CLERMONT": "Australia/Brisbane",  # QLD â†’ +10 AEST                 â”‚
â”‚  }                                                                      â”‚
â”‚                      â”‚                                                  â”‚
â”‚                      â–¼                                                  â”‚
â”‚  Silver Data (Local Time):                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚  facility  â”‚     timestamp_local      â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚  â”‚  NYNGAN    â”‚  2025-12-04 09:00 local â”‚  (+11h)                      â”‚
â”‚  â”‚  CLERMONT  â”‚  2025-12-04 08:00 local â”‚  (+10h)                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Táº¡i sao cáº§n convert timezone?**
- OpenElectricity API tráº£ vá» **UTC**
- Solar energy phá»¥ thuá»™c vÃ o **giá» Ä‘á»‹a phÆ°Æ¡ng** (máº·t trá»i lÃªn/xuá»‘ng)
- Äá»ƒ join vá»›i weather data (Ä‘Ã£ lÃ  local time) â†’ cáº§n cÃ¹ng timezone

---

#### Hour-End Labeling Convention:

```python
# Shift interval_start by +1 hour
# so the energy measured over [t, t+1) is labelled at the hour-end (t+1)
.withColumn("date_hour", 
    F.date_trunc("hour", F.expr("timestamp_local + INTERVAL 1 HOUR")))
```

**Giáº£i thÃ­ch:**

| Code | Giáº£i thÃ­ch |
|------|------------|
| `timestamp_local + INTERVAL 1 HOUR` | ThÃªm 1 giá» vÃ o timestamp |
| `F.date_trunc("hour", ...)` | Cáº¯t bá» phÃºt/giÃ¢y, giá»¯ láº¡i giá» trÃ²n |

**Táº¡i sao cáº§n Hour-End Labeling?**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HOUR-END LABELING CONVENTION                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Dá»¯ liá»‡u Hourly trong Bronze (UTC):                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  08:00 UTC - 09:00 UTC â†’ 100 MWh                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  NÄƒng lÆ°á»£ng trong giá» [08:00 - 09:00) UTC                               â”‚
â”‚                                                                         â”‚
â”‚  â“ Label giá» nÃ y lÃ  08:00 hay 09:00?                                  â”‚
â”‚                                                                         â”‚
â”‚  âœ“ HOUR-END: Label = 09:00                                             â”‚
â”‚    â†’ NÄƒng lÆ°á»£ng phÃ¡t sinh TRÆ¯á»šC giá» 09:00                              â”‚
â”‚    â†’ PhÃ¹ há»£p vá»›i electricity market convention                          â”‚
â”‚                                                                         â”‚
â”‚  âœ— HOUR-START: Label = 08:00                                           â”‚
â”‚    â†’ CÃ³ thá»ƒ gÃ¢y nháº§m láº«n                                               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### Validation Rules:

**Hard Bounds (â†’ BAD):**
```python
ENERGY_LOWER = 0.0  # NÄƒng lÆ°á»£ng khÃ´ng thá»ƒ Ã¢m
is_within_bounds = energy_mwh >= ENERGY_LOWER
```

**Giáº£i thÃ­ch:**
- NÄƒng lÆ°á»£ng solar **khÃ´ng thá»ƒ Ã¢m** (chá»‰ phÃ¡t ra, khÃ´ng tiÃªu thá»¥)
- Náº¿u `energy_mwh < 0` â†’ Data error â†’ Mark as **BAD**

---

**Soft Checks (â†’ WARNING):**

| Check | Condition | LÃ½ do |
|-------|-----------|-------|
| NIGHT_ENERGY_ANOMALY | hour âˆˆ [22, 6) AND energy > 1.0 MWh | Ban Ä‘Ãªm khÃ´ng cÃ³ Ã¡nh sÃ¡ng |
| DAYTIME_ZERO_ENERGY | hour âˆˆ [8, 17] AND energy == 0 | Ban ngÃ y pháº£i cÃ³ nÄƒng lÆ°á»£ng |
| EQUIPMENT_DOWNTIME | hour âˆˆ [10, 14] AND energy == 0 | Peak hours khÃ´ng thá»ƒ = 0 |
| TRANSITION_HOUR_LOW_ENERGY | Sunrise/sunset vá»›i energy tháº¥p báº¥t thÆ°á»ng | Äang trong transition period |
| PEAK_HOUR_LOW_ENERGY | Peak hours vá»›i energy < 50% expected | Hiá»‡u suáº¥t tháº¥p báº¥t thÆ°á»ng |

**Diagram minh há»a validation:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ENERGY VALIDATION BY HOUR                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   Energy                                                                â”‚
â”‚   (MWh)                                                                 â”‚
â”‚     â–²                                                                   â”‚
â”‚  150â”œ                     â”Œâ”€â”€â”€â”€â”€â”                                      â”‚
â”‚     â”‚                   â•±â”‚     â”‚â•²                                      â”‚
â”‚  100â”œ                 â•±  â”‚PEAK â”‚  â•²         GOOD âœ“                     â”‚
â”‚     â”‚    â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â•±    â”‚10-14â”‚    â•²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬                        â”‚
â”‚   50â”œ    â”‚       â•±      â””â”€â”€â”€â”€â”€â”˜      â•²       â”‚                        â”‚
â”‚     â”‚    â”‚RAMP â•±                       â•²RAMP â”‚                        â”‚
â”‚     â”‚    â”‚   â•± <8% â†’ WARNING            â•²    â”‚                        â”‚
â”‚     â”‚ â”Œâ”€â”€â”´â”€â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²â”€â”´â”€â”€â”                         â”‚
â”‚    1â”œâ”€â”¤NIGHTâ”‚                           â”‚NIGHTâ”œâ”€ >1MWh â†’ WARNING      â”‚
â”‚   0 â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚     00  04  06  08  10  12  14  16  18  20  22  24  Hour              â”‚
â”‚         â””â”€â”€NIGHTâ”€â”€â”˜                       â””â”€â”€NIGHTâ”€â”€â”˜                  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---


### ğŸŒ¦ï¸ 4.2 Silver Hourly Weather

**Loader:** [hourly_weather.py](file:///home/pvlakehouse/dlh-pv/src/pv_lakehouse/etl/silver/hourly_weather.py)

**Source:** `lh.bronze.raw_facility_weather`  
**Target:** `lh.silver.clean_hourly_weather`

#### Validation Bounds:

```python
_numeric_columns = {
    "shortwave_radiation": (0.0, 1150.0),    # W/mÂ²
    "direct_radiation": (0.0, 1050.0),       # W/mÂ²
    "diffuse_radiation": (0.0, 520.0),       # W/mÂ²
    "direct_normal_irradiance": (0.0, 1060.0), # W/mÂ²
    "temperature_2m": (-10.0, 50.0),         # Â°C
    "dew_point_2m": (-20.0, 30.0),           # Â°C
    "wet_bulb_temperature_2m": (-5.0, 40.0), # Â°C
    "cloud_cover": (0.0, 100.0),             # %
    "precipitation": (0.0, 1000.0),          # mm
    "sunshine_duration": (0.0, 3600.0),      # seconds
    "wind_speed_10m": (0.0, 50.0),           # m/s
    "wind_direction_10m": (0.0, 360.0),      # degrees
    "wind_gusts_10m": (0.0, 120.0),          # m/s
    "pressure_msl": (985.0, 1050.0),         # hPa
}
```

#### Soft Checks:

| Check | Condition | LÃ½ do |
|-------|-----------|-------|
| NIGHT_RADIATION_SPIKE | Night AND shortwave > 100 W/mÂ² | Sensor error |
| RADIATION_INCONSISTENCY | Direct + Diffuse > Shortwave Ã— 1.05 | Physics violation |
| CLOUD_MEASUREMENT_INCONSISTENCY | Peak sun AND cloud > 98% AND radiation < 600 | Suspicious measurement |
| EXTREME_TEMPERATURE | temp < -10Â°C OR temp > 45Â°C | Extreme event |

### ğŸ’¨ 4.3 Silver Hourly Air Quality

**Loader:** [hourly_air_quality.py](file:///home/pvlakehouse/dlh-pv/src/pv_lakehouse/etl/silver/hourly_air_quality.py)

**Source:** `lh.bronze.raw_facility_air_quality`  
**Target:** `lh.silver.clean_hourly_air_quality`

#### AQI Calculation (EPA Standard):

```python
def _aqi_from_pm25(self, column):
    """Calculate AQI from PM2.5 using EPA breakpoints."""
    return (
        F.when(column <= 12.0, scale(column, 0.0, 12.0, 0, 50))
        .when(column <= 35.4, scale(column, 12.1, 35.4, 51, 100))
        .when(column <= 55.4, scale(column, 35.5, 55.4, 101, 150))
        .when(column <= 150.4, scale(column, 55.5, 150.4, 151, 200))
        .when(column <= 250.4, scale(column, 150.5, 250.4, 201, 300))
        .otherwise(scale(column, 250.5, 500.0, 301, 500))
    )
```

#### AQI Categories:

| AQI Range | Category | Health Impact |
|-----------|----------|---------------|
| 0-50 | **Good** | Air quality is satisfactory |
| 51-100 | **Moderate** | Acceptable; may be risk for sensitive groups |
| 101-200 | **Unhealthy** | Everyone may begin to experience effects |
| 201-500 | **Hazardous** | Health alert; serious health effects |

### ğŸš€ Lá»‡nh Cháº¡y Silver Jobs

```bash
# Energy - Incremental (default)
docker compose -f docker/docker-compose.yml exec spark-master \
  spark-submit --master spark://spark-master:7077 \
  --driver-memory 2g --executor-memory 3g \
  /opt/workdir/src/pv_lakehouse/etl/silver/cli.py hourly_energy \
  --mode incremental --load-strategy merge

# Weather - Incremental
docker compose -f docker/docker-compose.yml exec spark-master \
  spark-submit --master spark://spark-master:7077 \
  --driver-memory 2g --executor-memory 3g \
  /opt/workdir/src/pv_lakehouse/etl/silver/cli.py hourly_weather \
  --mode incremental --load-strategy merge

# Air Quality - Incremental
docker compose -f docker/docker-compose.yml exec spark-master \
  spark-submit --master spark://spark-master:7077 \
  --driver-memory 2g --executor-memory 3g \
  /opt/workdir/src/pv_lakehouse/etl/silver/cli.py hourly_air_quality \
  --mode incremental --load-strategy merge
```

### ğŸ“Š Verify Data Quality

```sql
-- Check quality flag distribution
SELECT 
    quality_flag,
    COUNT(*) AS count,
    ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER(), 2) AS pct
FROM iceberg.silver.clean_hourly_energy
GROUP BY quality_flag
ORDER BY count DESC;

-- Find records with issues
SELECT 
    facility_code, date_hour, energy_mwh, quality_flag, quality_issues
FROM iceberg.silver.clean_hourly_energy
WHERE quality_flag IN ('WARNING', 'BAD')
ORDER BY date_hour DESC
LIMIT 50;
```

---

## ğŸ“š TÃ€I LIá»†U THAM KHáº¢O

### Documentation Files

| File | MÃ´ Táº£ |
|------|-------|
| [BRONZE_LAYER.md](file:///home/pvlakehouse/dlh-pv/doc/bronze-silver/BRONZE_LAYER.md) | TÃ i liá»‡u Bronze layer |
| [SILVER_LAYER.md](file:///home/pvlakehouse/dlh-pv/doc/bronze-silver/SILVER_LAYER.md) | TÃ i liá»‡u Silver layer |
| [SILVER_VALIDATION_RULES.md](file:///home/pvlakehouse/dlh-pv/doc/bronze-silver/SILVER_VALIDATION_RULES.md) | Validation rules chi tiáº¿t |
| [ETL_OPERATIONS_GUIDE.md](file:///home/pvlakehouse/dlh-pv/doc/bronze-silver/ETL_OPERATIONS_GUIDE.md) | HÆ°á»›ng dáº«n cháº¡y ETL |
| [README-SETUP.md](file:///home/pvlakehouse/dlh-pv/docker/README-SETUP.md) | HÆ°á»›ng dáº«n cÃ i Ä‘áº·t Docker |

### API Documentation

- **Open-Meteo Weather:** https://open-meteo.com/en/docs
- **Open-Meteo Air Quality:** https://open-meteo.com/en/docs/air-quality-api
- **OpenElectricity:** https://openelectricity.org.au/docs

---

## ğŸ“ Káº¾T LUáº¬N

Chung Quang ÄÄƒng Khoa Ä‘Ã£ thá»±c hiá»‡n Ä‘áº§y Ä‘á»§ cÃ¡c cÃ´ng viá»‡c Ä‘Æ°á»£c phÃ¢n cÃ´ng:

1. âœ… **CÃ i Ä‘áº·t vÃ  cáº¥u hÃ¬nh há»‡ thá»‘ng:** Thiáº¿t láº­p Docker Compose vá»›i MinIO, Spark, Trino, PostgreSQL, MLflow
2. âœ… **NghiÃªn cá»©u nguá»“n dá»¯ liá»‡u:** NghiÃªn cá»©u 3 API sources (Open-Meteo Weather, Air Quality, OpenElectricity)
3. âœ… **Náº¡p dá»¯ liá»‡u Bronze:** XÃ¢y dá»±ng 3 Bronze loaders vá»›i incremental/backfill modes, rate limiting, error handling
4. âœ… **Xá»­ lÃ½ dá»¯ liá»‡u Silver:** XÃ¢y dá»±ng 3 Silver loaders vá»›i timezone conversion, validation, quality flags, AQI calculation

**Tá»•ng sá»‘ files code liÃªn quan:**
- Bronze loaders: 8 files
- Silver loaders: 7 files  
- API clients: 3 files
- Documentation: 11+ files
